rule_files:
  - mise-prometheusRule.yaml

evaluation_interval: 1s

tests:
- interval: 1s
  input_series:
    - series: 'up{job="envoy-stats", namespace="mise"}'
      values: '1x100 0x500'  # 100s healthy, 400s down
  alert_rule_test:
    - eval_time: 401s  # alert should fire after 5m of 0s
      alertname: MiseEnvoyScrapeDown
      exp_alerts:
        - exp_labels:
            alertname: MiseEnvoyScrapeDown
            severity: info
            job: envoy-stats
            namespace: mise
          exp_annotations:
            summary: "Envoy scrape target down for namespace=mise"
            description: "Prometheus scrape for envoy-stats job in namespace mise is failing or missing."
            runbook_url: 'TBD'

- interval: 1s
  input_series: []  # No 'up' series at all (absent)
  alert_rule_test:
    - eval_time: 300s  # Alert should fire because series is missing for 5m
      alertname: MiseEnvoyScrapeDown
      exp_alerts:
        - exp_labels:
            alertname: MiseEnvoyScrapeDown
            severity: info
            job: envoy-stats
            namespace: mise
          exp_annotations:
            summary: "Envoy scrape target down for namespace=mise"
            description: "Prometheus scrape for envoy-stats job in namespace mise is failing or missing."
            runbook_url: 'TBD'

# Test: Envoy up and healthy for 10 minutes (no alert should fire)
- interval: 1s
  input_series:
    - series: 'up{job="envoy-stats", namespace="mise"}'
      values: '1x600'
  alert_rule_test:
    - eval_time: 600s
      alertname: MiseEnvoyScrapeDown
      exp_alerts: []
