---
# Source: frontend/templates/frontend.poddisruptionbudget.yaml
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: aro-hcp-frontend
  namespace: 'aro-hcp'
spec:
  minAvailable: 1
  selector:
    matchLabels:
      app: aro-hcp-frontend
---
# Source: frontend/templates/serviceaccount.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  annotations:
    azure.workload.identity/client-id: '__frontendMsiClientId__'
    azure.workload.identity/tenant-id: '__frontendMsiTenantId__'
  name: frontend
  namespace: 'aro-hcp'
---
# Source: frontend/templates/frontend.configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: frontend-config
  namespace: 'aro-hcp'
data:
  DB_NAME: 'arohcpdev-rp-usw3'
  DB_URL: '__cosmosDBDocumentEndpoint__'
  FRONTEND_MI_CLIENT_ID: '__frontendMsiClientId__'
  LOCATION: 'westus3'
---
# Source: frontend/templates/frontend.service.yaml
apiVersion: v1
kind: Service
metadata:
  labels:
    app: aro-hcp-frontend
  name: aro-hcp-frontend
  namespace: 'aro-hcp'
spec:
  ports:
  - port: 8443
    protocol: TCP
    targetPort: 8443
  selector:
    app: aro-hcp-frontend
  type: ClusterIP
---
# Source: frontend/templates/metrics.service.yaml
apiVersion: v1
kind: Service
metadata:
  labels:
    app: aro-hcp-frontend
    port: metrics
  name: aro-hcp-frontend-metrics
  namespace: 'aro-hcp'
spec:
  ports:
  - port: 8081
    protocol: TCP
    targetPort: 8081
    name: metrics
  selector:
    app: aro-hcp-frontend
---
# Source: frontend/templates/frontend.deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: aro-hcp-frontend
  name: aro-hcp-frontend
  namespace: 'aro-hcp'
spec:
  progressDeadlineSeconds: 600
  replicas: 2
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      app: aro-hcp-frontend
  strategy:
    rollingUpdate:
      maxSurge: 50%
      maxUnavailable: 50%
    type: RollingUpdate
  template:
    metadata:
      labels:
        app: aro-hcp-frontend
        azure.workload.identity/use: "true"
    spec:
      topologySpreadConstraints:
      - maxSkew: 1
        topologyKey: 'topology.kubernetes.io/zone'
        whenUnsatisfiable: ScheduleAnyway
        labelSelector:
          matchLabels:
            app: aro-hcp-frontend
      - maxSkew: 1
        topologyKey: kubernetes.io/hostname
        whenUnsatisfiable: ScheduleAnyway
        labelSelector:
          matchLabels:
            app: aro-hcp-frontend
      serviceAccountName: 'frontend'
      containers:
      - name: aro-hcp-frontend
        image: 'arohcpsvcdev.azurecr.io/arohcpfrontend@sha256:1234567890'
        imagePullPolicy: Always
        args: ["--clusters-service-url", "http://clusters-service.clusters-service.svc.cluster.local:8000"]
        env:
        - name: DB_NAME
          valueFrom:
            configMapKeyRef:
              name: frontend-config
              key: DB_NAME
        - name: DB_URL
          valueFrom:
            configMapKeyRef:
              name: frontend-config
              key: DB_URL
        - name: LOCATION
          valueFrom:
            configMapKeyRef:
              name: frontend-config
              key: LOCATION
        - name: OTEL_EXPORTER_OTLP_ENDPOINT
          value: ""
        - name: OTEL_TRACES_EXPORTER
          value: ""
        - name: AUDIT_CONNECT_SOCKET
          value: "false"
        ports:
        - containerPort: 8443
          protocol: TCP
        - containerPort: 8081
          protocol: TCP
        resources:
          limits:
            memory: 1Gi
          requests:
            cpu: 100m
            memory: 500Mi
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
          runAsNonRoot: true
          seccompProfile:
            type: RuntimeDefault
        livenessProbe:
          httpGet:
            path: /healthz
            port: 8443
          initialDelaySeconds: 15
          periodSeconds: 20
          failureThreshold: 3
        readinessProbe:
          httpGet:
            path: /healthz
            port: 8443
          initialDelaySeconds: 5
          periodSeconds: 10
      restartPolicy: Always
      terminationGracePeriodSeconds: 30
---
# Source: frontend/templates/frontend.secret-refresher.yaml
################################
#
# This keeps the certificate secret fresh because the secret is mounted from the keyVault (via the SecretProviderClass) and
# it's if the certificate changes in the keyvault this will trigger the refreshing of the kubernetes secret.
#
# Note: the istio plugin doesn't support using the SecretProviderClass directly. When it does this can be removed.
#
################################
apiVersion: apps/v1
kind: Deployment
metadata:
  name: frontend-certificate-refresher
  namespace: aks-istio-ingress
spec:
  replicas: 1
  selector:
    matchLabels:
      app: frontend-certificate-refresher
  template:
    metadata:
      labels:
        app: frontend-certificate-refresher
    spec:
      containers:
      - command:
        - "/bin/sleep"
        - "infinity"
        image: mcr.microsoft.com/cbl-mariner/busybox:1.35
        name: init-container-msg-container-init
        volumeMounts:
        - name: secrets-store01-inline
          mountPath: "/mnt/secrets-store"
          readOnly: true
      volumes:
      - name: secrets-store01-inline
        csi:
          driver: secrets-store.csi.k8s.io
          readOnly: true
          volumeAttributes:
            secretProviderClass: "frontend-scp"
---
# Source: frontend/templates/acrpullbinding.yaml
apiVersion: acrpull.microsoft.com/v1beta2
kind: AcrPullBinding
metadata:
  name: frontend-pull-binding
  namespace: 'aro-hcp'
spec:
  acr:
    environment: PublicCloud
    server: 'arohcpsvcdev.azurecr.io'
    scope: 'repository:arohcpfrontend:pull'
  auth:
    workloadIdentity:
      serviceAccountRef: 'frontend'
      clientID: '__imagePullerMsiClientId__'
      tenantID: '__imagePullerMsiTenantId__'
  serviceAccountName: 'frontend'
---
# Source: frontend/templates/allow-admin.authorizationpolicy.yaml
apiVersion: security.istio.io/v1
kind: AuthorizationPolicy
metadata:
  name: allow-admin-api-to-frontend
  namespace: 'aro-hcp'
spec:
  action: "ALLOW"
  rules:
  - from:
    - source:
        principals:
        - "cluster.local/ns/aro-hcp-admin-api/sa/admin-api"
    to:
    - operation:
        ports:
        - "8443"
  selector:
    matchLabels:
      app: "aro-hcp-frontend"
---
# Source: frontend/templates/allow-ingress.authorizationpolicy.yaml
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: allow-istio-ingress
  namespace: 'aro-hcp'
spec:
  action: ALLOW
  rules:
  - from:
    - source:
        namespaces: ["aks-istio-ingress"]
    to:
    - operation:
        methods: ["GET", "PUT", "POST", "PATCH", "DELETE"]
        ports:
        - "8443"
---
# Source: frontend/templates/allow-metrics.authorizationpolicy.yaml
apiVersion: security.istio.io/v1
kind: AuthorizationPolicy
metadata:
  name: allow-metrics-frontend
  namespace: 'aro-hcp'
spec:
  action: "ALLOW"
  rules:
  - to:
    - operation:
        paths: ["/metrics"]
        methods: ["GET"]
        ports: ["8081"]
  selector:
    matchLabels:
      app: "aro-hcp-frontend"
---
# Source: frontend/templates/authorizationpolicy.yaml
apiVersion: security.istio.io/v1
kind: AuthorizationPolicy
metadata:
  name: allow-nothing
  namespace: 'aro-hcp'
spec: {}
---
# Source: frontend/templates/frontend.gateway.yaml
apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: aro-hcp-gateway-external
  namespace: aks-istio-ingress
  annotations:
    helm.sh/resource-policy: keep
spec:
  selector:
    istio: aks-istio-ingressgateway-external
  servers:
  - port:
      number: 443
      name: frontend-https
      protocol: HTTPS
    tls:
      mode: SIMPLE
      credentialName: frontend-credential
    hosts:
    - "rp.westus3.hcpsvc.osadev.cloud"
  - port:
      number: 443
      name: admin-api-https
      protocol: HTTPS
    tls:
      mode: SIMPLE
      credentialName: admin-api-credential
    hosts:
    - "admin.westus3.hcpsvc.osadev.cloud"
---
# Source: frontend/templates/peerauthentication.yaml
apiVersion: security.istio.io/v1beta1
kind: PeerAuthentication
metadata:
  name: aro-hcp-frontend-metrics
  namespace: 'aro-hcp'
spec:
  selector:
    matchLabels:
      app: aro-hcp-frontend
  portLevelMtls:
    8081:
      mode: PERMISSIVE
---
# Source: frontend/templates/frontend.secretproviderclass.yaml
################################
#
# The addition of the secretObjects is to facilitate the istio plugin as it can't yet consume  the SecretProviderClass directly.
# When it does this can be simplified and the secret.refresher removed.
#
################################
apiVersion: secrets-store.csi.x-k8s.io/v1
kind: SecretProviderClass
metadata:
  name: frontend-scp
  namespace: aks-istio-ingress
spec:
  parameters:
    usePodIdentity: "false"
    useVMManagedIdentity: "true"
    userAssignedIdentityID: '__csiSecretStoreClientId__'
    keyvaultName: 'aro-hcp-dev-svc-kv'
    objects: |-
      array:
        - |
          objectName: 'frontend-cert-dev-usw3'
          objectType: secret
          objectAlias: frontend-cert
    tenantId: '__tenantId__'
  provider: azure
  secretObjects:
  - secretName: frontend-credential
    type: kubernetes.io/tls
    data:
    - objectName: frontend-cert
      key: tls.crt
    - objectName: frontend-cert
      key: tls.key
---
# Source: frontend/templates/servicemonitor.yaml
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: aro-hcp-frontend
  namespace: 'aro-hcp'
spec:
  endpoints:
  - interval: 30s
    path: /metrics
    port: metrics
    scheme: http
  namespaceSelector:
    matchNames:
    - 'aro-hcp'
  selector:
    matchLabels:
      app: aro-hcp-frontend
      port: metrics
---
# Source: frontend/templates/frontend.virtualservice.yaml
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: aro-hcp-vs-frontend
  namespace: 'aro-hcp'
spec:
  hosts:
  - "rp.westus3.hcpsvc.osadev.cloud"
  gateways:
  - aks-istio-ingress/aro-hcp-gateway-external
  http:
  - match:
    - uri:
        regex: '.+'
    headers:
      request:
        add:
          mise-inbound-policies-to-filter: "ARM Policy"
    route:
    - destination:
        host: aro-hcp-frontend
        port:
          number: 8443

