---
# Source: maestro-agent/templates/maestro.serviceaccount.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  annotations:
    azure.workload.identity/client-id: '__msiClientId__'
  name: 'maestro'
  namespace: 'maestro'
---
# Source: maestro-agent/templates/metrics-proxy.serviceaccount.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: metrics-proxy-sa
  namespace: 'maestro'
automountServiceAccountToken: true
---
# Source: maestro-agent/templates/maestro.secret.yaml
apiVersion: v1
kind: Secret
metadata:
  name: maestro
  namespace: 'maestro'
stringData:
  config.yaml: |
    brokerHost: "__brokerHost__:8883"
    username: ""
    password: ""
    clientCertFile: /secrets/mqtt-creds/maestro.crt
    clientKeyFile: /secrets/mqtt-creds/maestro.key
    topics:
      sourceEvents: sources/maestro/consumers/hcp-underlay-usw3-mgmt-1/sourceevents
      agentEvents: sources/maestro/consumers/hcp-underlay-usw3-mgmt-1/agentevents
---
# Source: maestro-agent/templates/metrics-access-token.secret.yaml
apiVersion: v1
kind: Secret
metadata:
  name: metrics-access-token
  namespace: 'maestro'
  annotations:
    kubernetes.io/service-account.name: metrics-proxy-sa
type: kubernetes.io/service-account-token
---
# Source: maestro-agent/templates/metrics-proxy.configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-config
  namespace: 'maestro'
data:
  nginx.conf: |
    worker_processes auto;
    pid /run/nginx.pid;

    events {
        worker_connections 1024;
    }

    http {
        access_log  /dev/null;
        error_log  /dev/null;

        server {
            listen 8080;

            location / {
                proxy_ssl_verify off;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

                proxy_set_header Authorization "Bearer TOKEN";
                proxy_pass https://localhost:8443;
            }
        }
    }
---
# Source: maestro-agent/templates/maestro-agent.agent.clusterrole.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: maestro-agent:agent-dev-westus3-mgmt-1-maestro-agent
rules:
- apiGroups:
  - work.open-cluster-management.io
  resources:
  - appliedmanifestworks
  verbs:
  - get
  - list
  - watch
  - create
  - update
  - patch
  - delete
- apiGroups:
  - work.open-cluster-management.io
  resources:
  - appliedmanifestworks/status
  verbs:
  - patch
  - update
- apiGroups:
  - work.open-cluster-management.io
  resources:
  - appliedmanifestworks/finalizers
  verbs:
  - update
- apiGroups:
  - authorization.k8s.io
  resources:
  - subjectaccessreviews
  verbs:
  - create
- apiGroups:
  - ""
  resources:
  - serviceaccounts
  verbs:
  - impersonate
---
# Source: maestro-agent/templates/metrics-proxy.clusterrole.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: metrics-proxy-access
rules:
- nonResourceURLs:
  - "/metrics"
  verbs:
  - get
---
# Source: maestro-agent/templates/maestro-agent.agent.clusterrolebinding.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: maestro-agent:agent-dev-westus3-mgmt-1-maestro-agent
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: maestro-agent:agent-dev-westus3-mgmt-1-maestro-agent
subjects:
- kind: ServiceAccount
  name: 'maestro'
  namespace: 'maestro'
---
# Source: maestro-agent/templates/maestro-agent.execution-admin.clusterrolebinding.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: maestro-agent:execution-admin-dev-westus3-mgmt-1-maestro-agent
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin
subjects:
- kind: ServiceAccount
  name: 'maestro'
  namespace: 'maestro'
---
# Source: maestro-agent/templates/maestro-agent.execution.clusterrolebinding.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: maestro-agent:execution
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: maestro-agent:execution
subjects:
- kind: ServiceAccount
  name: 'maestro'
  namespace: 'maestro'
---
# Source: maestro-agent/templates/metrics-proxy.clusterrolebinding.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: metrics-proxy-access-cluster-role-binding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: metrics-proxy-access
subjects:
- kind: ServiceAccount
  name: metrics-proxy-sa
  namespace: 'maestro'
---
# Source: maestro-agent/templates/maestro-agent.agent-extension-apiserver.role.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: maestro-agent:agent:extension-apiserver-dev-westus3-mgmt-1-maestro-agent
  namespace: kube-system
rules:
- apiGroups:
  - ""
  resourceNames:
  - extension-apiserver-authentication
  resources:
  - configmaps
  verbs:
  - get
  - list
  - watch
---
# Source: maestro-agent/templates/maestro-agent.agent.role.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: maestro-agent:agent
  namespace: 'maestro'
rules:
- apiGroups:
  - ""
  resources:
  - configmaps
  verbs:
  - get
  - list
  - watch
  - create
  - delete
  - update
  - patch
- apiGroups:
  - coordination.k8s.io
  resources:
  - leases
  verbs:
  - create
  - get
  - list
  - update
  - watch
  - patch
- apiGroups:
  - ""
  - events.k8s.io
  resources:
  - events
  verbs:
  - create
  - patch
  - update
---
# Source: maestro-agent/templates/maestro-agent.agent-extension-apiserver.rolebinding.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: maestro-agent:agent:extension-apiserver-dev-westus3-mgmt-1-maestro-agent
  namespace: kube-system
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: maestro-agent:agent:extension-apiserver-dev-westus3-mgmt-1-maestro-agent
subjects:
- kind: ServiceAccount
  name: 'maestro'
  namespace: 'maestro'
---
# Source: maestro-agent/templates/maestro-agent.agent.rolebinding.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: maestro-agent:agent
  namespace: 'maestro'
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: maestro-agent:agent
subjects:
- kind: ServiceAccount
  name: 'maestro'
  namespace: 'maestro'
---
# Source: maestro-agent/templates/maestro-agent.deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: maestro-agent
  name: maestro-agent
  namespace: 'maestro'
spec:
  replicas: 3
  selector:
    matchLabels:
      app: maestro-agent
  template:
    metadata:
      labels:
        app: maestro-agent
      annotations:
        checksum/credsstore: 'fce571090494f556451e1c1151e4f011c8a654bdf3c74d0e18f96a45d42c3609'
        checksum/config: '95d5834e582ee0af647b83396df40b977535fd9050ba7d580fc505d709c96086'
    spec:
      topologySpreadConstraints:
      - maxSkew: 1
        topologyKey: 'topology.kubernetes.io/zone'
        whenUnsatisfiable: ScheduleAnyway
        labelSelector:
          matchLabels:
            app: maestro-agent
      - maxSkew: 1
        topologyKey: kubernetes.io/hostname
        whenUnsatisfiable: ScheduleAnyway
        labelSelector:
          matchLabels:
            app: maestro-agent
      initContainers:
      - name: init
        image: "mcr.microsoft.com/azurelinux/base/nginx@sha256:1234567890"
        env:
        - name: TOKEN
          valueFrom:
            secretKeyRef:
              name: metrics-access-token
              key: token
        volumeMounts:
        - name: nginx-config
          mountPath: /etc/nginx/
        - name: nginx-config-tmp
          mountPath: /tmp/nginx/nginx.conf
          subPath: nginx.conf
        command:
        - sh
        - -c
        - cp /tmp/nginx/nginx.conf /etc/nginx/nginx.conf && sed -i "s/TOKEN/$TOKEN/g" /etc/nginx/nginx.conf
      containers:
      - name: metrics-proxy
        image: "mcr.microsoft.com/azurelinux/base/nginx@sha256:1234567890"
        ports:
        - containerPort: 8080
          name: metrics
          protocol: TCP
        volumeMounts:
        - name: nginx-config
          mountPath: /etc/nginx/nginx.conf
          subPath: nginx.conf
        command: ["/bin/sh", "-c", "nginx -g 'daemon off;'"]
      - command:
        - /usr/local/bin/maestro
        - agent
        - --consumer-name=hcp-underlay-usw3-mgmt-1
        - --workload-source-driver=mqtt
        - --workload-source-config=/secrets/maestro/config.yaml
        - --cloudevents-client-id=hcp-underlay-usw3-mgmt-1-work-agent
        - --disable-leader-election=false
        - -v=2
        image: "arohcpsvcdev.azurecr.io/redhat-user-workloads/maestro-rhtap-tenant/maestro/maestro@sha256:1234567890"
        imagePullPolicy: IfNotPresent
        name: maestro-agent
        volumeMounts:
        - mountPath: /secrets/maestro
          name: maestro
        - mountPath: /secrets/mqtt-creds
          name: mqtt-creds
          readOnly: true
      serviceAccountName: 'maestro'
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: aro-hcp.azure.com/role
                operator: In
                values:
                - infra
      tolerations:
      - effect: NoSchedule
        key: infra
        operator: "Equal"
        value: "true"
      volumes:
      - name: nginx-config-tmp
        configMap:
          name: nginx-config
      - name: nginx-config
        emptyDir: {}
      - name: maestro
        secret:
          secretName: maestro
      - csi:
          driver: secrets-store.csi.k8s.io
          readOnly: true
          volumeAttributes:
            secretProviderClass: maestro
        name: mqtt-creds
---
# Source: maestro-agent/templates/appliedmanifestworks.work.open-cluster-management.io.customresourcedefinition.yaml
#
---
# Source: maestro-agent/templates/maestro-agent.podmonitor.yaml
apiVersion: monitoring.coreos.com/v1
kind: PodMonitor
metadata:
  name: maestro-agent
  namespace: 'maestro'
spec:
  selector:
    matchLabels:
      app: maestro-agent
  namespaceSelector:
    matchNames:
    - 'maestro'
  podMetricsEndpoints:
  - path: /metrics
    port: metrics
    scheme: http
---
# Source: maestro-agent/templates/maestro.secretproviderclass.yaml
apiVersion: secrets-store.csi.x-k8s.io/v1
kind: SecretProviderClass
metadata:
  name: maestro
  namespace: 'maestro'
spec:
  parameters:
    clientID: '__msiClientId__'
    cloudName: 'AzurePublicCloud'
    keyvaultName: 'ah-dev-mg-usw3-1'
    objects: |-
      array:
        - |
          objectName: 'hcp-underlay-usw3-mgmt-1'
          objectType: secret
          objectAlias: maestro
    tenantId: '__tenantId__'
    usePodIdentity: "false"
  provider: azure

