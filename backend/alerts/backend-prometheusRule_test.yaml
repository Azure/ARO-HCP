rule_files:
- backend-prometheusRule.yaml
evaluation_interval: 1m
tests:
# Test: BackendOperationErrorRate above 5%
- interval: 1m
  input_series:
  - series: 'backend_failed_operations_total{type="create"}'
    values: "0 6x10" # 6 failures per minute → 6 / 106 ≈ 5.66%
  - series: 'backend_operations_total{type="create"}'
    values: "0 100x10" # 100 operations per minute from minute 1 to 10
  alert_rule_test:
  - eval_time: 10m # At this point, the condition has held for 10 minutes
    alertname: BackendOperationErrorRate
    exp_alerts:
    - exp_labels:
        severity: info
      exp_annotations:
        description: 'The Backend operation error rate is above 5% for the last hour. Current value: 6%.'
        runbook_url: 'TBD'
        summary: 'High Error Rate on Backend Operations'
# Test: BackendOperationErrorRate below 5%
- interval: 1m
  input_series:
  - series: 'backend_failed_operations_total{type="create"}'
    values: "0 2x10" # 2 failures / 102 total ≈ 1.96%
  - series: 'backend_operations_total{type="create"}'
    values: "0 100x10" # 100 operations per minute from minute 1 to 10
  alert_rule_test:
  - eval_time: 10m # At this point, the condition has held for 10 minutes
    alertname: BackendOperationErrorRate
    exp_alerts: []
# Test: BackendControllerDegraded above 5%
- interval: 1m
  input_series:
  - series: 'backend_controller_status_conditions{cluster="test-cluster", resource_type="hcpOpenShiftClusters", controller_name="cluster-validation", condition="Degraded", status="True"}'
    values: "2+0x10" # Constant 2 degraded
  - series: 'backend_controller_status_conditions{cluster="test-cluster", resource_type="hcpOpenShiftClusters", controller_name="cluster-validation", condition="Degraded", status="False"}'
    values: "18+0x10" # Constant 18 not degraded → 2/20 = 10%
  alert_rule_test:
  - eval_time: 5m
    alertname: BackendControllerDegraded
    exp_alerts:
    - exp_labels:
        severity: warning
        cluster: test-cluster
        resource_type: hcpOpenShiftClusters
        controller_name: cluster-validation
      exp_annotations:
        description: 'Controller cluster-validation is degraded for more than 5% of hcpOpenShiftClusters resources. Current degradation rate: 10%.'
        runbook_url: 'TBD'
        summary: 'Controller cluster-validation degradation detected'
# Test: BackendControllerDegraded below 5%
- interval: 1m
  input_series:
  - series: 'backend_controller_status_conditions{cluster="test-cluster", resource_type="hcpOpenShiftClusters", controller_name="cluster-validation", condition="Degraded", status="True"}'
    values: "4+0x10" # Constant 4 degraded
  - series: 'backend_controller_status_conditions{cluster="test-cluster", resource_type="hcpOpenShiftClusters", controller_name="cluster-validation", condition="Degraded", status="False"}'
    values: "96+0x10" # Constant 96 not degraded → 4/100 = 4%
  alert_rule_test:
  - eval_time: 10m
    alertname: BackendControllerDegraded
    exp_alerts: []
