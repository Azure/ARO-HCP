#
# Purpose: Run PROW E2E tests
#
$schema: "pipeline.schema.v1"
serviceGroup: Microsoft.Azure.ARO.HCP.E2E
rolloutName: E2E Tests
buildStep:
  command: 'make'
  args:
  - prow-job-executor
resourceGroups:
- name: global
  resourceGroup: '{{ .global.rg }}'
  subscription: '{{ .global.subscription.key }}'
  steps:
  - name: output
    action: ARM
    template: ../dev-infrastructure/templates/output-global.bicep
    parameters: ../dev-infrastructure/configurations/output-global.tmpl.bicepparam
    deploymentLevel: ResourceGroup
    outputOnly: true
- name: service
  resourceGroup: '{{ .svc.rg }}'
  subscription: '{{ .svc.subscription.key }}'
  steps: []
  validationSteps:
  - name: regionalGating
    action: Shell
    command: ./execute-prow-job.sh
    validation:
    - GA
    dryRun:
      variables:
      - name: DRY_RUN
        value: "true"
    variables:
    - name: PROW_TOKEN_KEYVAULT
      configRef: global.keyVault.name
    - name: PROW_TOKEN_SECRET
      configRef: e2e.prow.globalKeyVaultTokenSecret
    - name: PROW_JOB_NAME
      configRef: e2e.regionTest.prowJobName
    - name: GATE_PROMOTION
      configRef: e2e.regionTest.gatePromotion
    - name: REGION
      configRef: region
    - name: KEY_VAULT_DNSSUFFIX
      configRef: keyVaultDNSSuffix
    - name: PROW_JOB_EXECUTOR
      value: './prow-job-executor'
    automatedRetry:
      errorContainsAny:
      - "encountered an error"
      maximumRetryCount: 1
      durationBetweenRetries: 2m
    shellIdentity:
      input:
        resourceGroup: global
        step: output
        name: globalMSIId
