---
# Source: istio/charts/mise/templates/configmap-misev2.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: misev2-config
  namespace: 'mise'
data:
  appsettings.json: |-
    {
      "$schema": "https://identitydivision.visualstudio.com/DevEx/_git/MISE?path=/schemas/mise-options-schema.json",
      "MiseVersion": "2.0",
      "AllowedHosts": "*",
      "EnableInboundPolicyFilter": true,
      "AzureAd": {
        "Instance": "https://login.microsoftonline.com/",
        "ClientId": "b3cb2fab-15cb-4583-ad06-f91da9bfe2d1",
        "TenantId": "33e01921-4d64-4f8c-a055-5bdaffd5e33d",
        "Audience": "api://b3cb2fab-15cb-4583-ad06-f91da9bfe2d1",
        "Logging": {
          "LogLevel": "Information"
        },
        "InboundPolicies": [
          {
            "Label": "ARM Policy",
            "Authority": "https://login.microsoftonline.com/33e01921-4d64-4f8c-a055-5bdaffd5e33d",
            "Audience": "https://management.azure.com",
            "ValidApplicationIds": [
              "e2c2ff5c-e5b4-4e79-8c3e-1da8c48461e7"
            ],
            "Protocols": {
              "Pop": {
                "SignedHttpRequestValidationParametersOptions": {
                  "ValidateTs": true,
                  "ValidateM": true,
                  "ValidateU": true,
                  "ValidateP": true
                }
              }
            }
          },
          {
            "Label": "Geneva Actions",
            "Authority": "https://sts.windows.net/__tenantId__/",
            "Audience": "https://management.azure.com",
            "ValidApplicationIds": [
              "__genevaActionsAppId__"
            ],
            "Protocols": {
              "Bearer": {
                "TokenTypes": {
                  "AccessToken": {
                    "AppToken": true
                  }
                }
              }
            }
          }
        ]
      },
      "Kestrel": {
        "Endpoints": {
          "Http": {
            "Url": "http://0.0.0.0:8080"
          }
        }
      },
      "Logging": {
        "LogLevel": {
          "Default": "Information",
          "Microsoft": "Information"
        }
      }
    }
---
# Source: istio/templates/istio-shared-configmap.yml
kind: ConfigMap
apiVersion: v1
metadata:
  labels:
    istio.io/rev: 'asm-1-26'
  name: istio-shared-configmap-asm-1-26
  namespace: aks-istio-system
data:
  mesh: |-
    extensionProviders:
    - name: "ext-authz"
      envoyExtAuthzHttp:
        service: "mise/mise.mise.svc.cluster.local"
        port: "8080"
        includeRequestHeadersInCheck: ["x-ext-authz", "mise-inbound-policies-to-filter"]
        pathPrefix: "/v1/EnvoyValidateRequest"
---
# Source: istio/charts/mise/templates/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: mise
  namespace: 'mise'
spec:
  selector:
    app: mise
  ports:
  - protocol: TCP
    port: 8080
    targetPort: 8080
---
# Source: istio/charts/mise/templates/deployment-misev2.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: misev2
  namespace: 'mise'
spec:
  replicas: 2
  selector:
    matchLabels:
      app: mise
      version: v2
  template:
    metadata:
      labels:
        app: mise
        version: v2
    spec:
      topologySpreadConstraints:
      - maxSkew: 1
        topologyKey: 'topology.kubernetes.io/zone'
        whenUnsatisfiable: ScheduleAnyway
        labelSelector:
          matchLabels:
            app: mise
            version: v2
      - maxSkew: 1
        topologyKey: kubernetes.io/hostname
        whenUnsatisfiable: ScheduleAnyway
        labelSelector:
          matchLabels:
            app: mise
            version: v2
      containers:
      - name: misev2
        image: "arohcpsvcdev.azurecr.io/mise-1p-container-image@sha256:1234567890"
        ports:
        - containerPort: 8080
        livenessProbe:
          httpGet:
            path: /healthz
            port: 8080
        readinessProbe:
          httpGet:
            path: /readyz
            port: 8080
        volumeMounts:
        - name: config
          mountPath: /app/appsettings.json
          subPath: appsettings.json
          readOnly: true
        env:
        - name: OTEL_EXPORTER_OTLP_ENDPOINT
          value: ""
        - name: OTEL_TRACES_EXPORTER
          value: ""
      volumes:
      - name: config
        configMap:
          name: misev2-config
---
# Source: istio/charts/mise/templates/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mise
  namespace: 'mise'
spec:
  replicas: 2
  selector:
    matchLabels:
      app: mise
  template:
    metadata:
      labels:
        app: mise
        version: v1
    spec:
      topologySpreadConstraints:
      - maxSkew: 1
        topologyKey: 'topology.kubernetes.io/zone'
        whenUnsatisfiable: ScheduleAnyway
        labelSelector:
          matchLabels:
            app: mise
      - maxSkew: 1
        topologyKey: kubernetes.io/hostname
        whenUnsatisfiable: ScheduleAnyway
        labelSelector:
          matchLabels:
            app: mise
      containers:
      - name: mise
        image: "arohcpsvcdev.azurecr.io/mise-1p-container-image@sha256:1234567890"
        ports:
        - containerPort: 8080
        livenessProbe:
          httpGet:
            path: /healthz
            port: 8080
        readinessProbe:
          httpGet:
            path: /readyz
            port: 8080
        env:
        - name: EnableInboundPolicyFilter
          value: "true"
        - name: AzureAd__Instance
          value: 'https://login.microsoftonline.com/'
        - name: AzureAd__ClientId
          value: 'b3cb2fab-15cb-4583-ad06-f91da9bfe2d1'
        - name: AzureAd__TenantId
          value: '33e01921-4d64-4f8c-a055-5bdaffd5e33d'
        - name: AzureAd__Audience
          value: "api://b3cb2fab-15cb-4583-ad06-f91da9bfe2d1"
        - name: AzureAd__InboundPolicies__0__Label
          value: "ARM Policy"
        - name: AzureAd__InboundPolicies__0__Authority
          value: "https://login.microsoftonline.com/33e01921-4d64-4f8c-a055-5bdaffd5e33d"
        - name: AzureAd__InboundPolicies__0__AuthenticationSchemes__0
          value: "PoP"
        - name: AzureAd__InboundPolicies__0__ValidAudiences__0
          value: 'https://management.azure.com'
        - name: AzureAd__InboundPolicies__0__ValidApplicationIds__0
          value: 'e2c2ff5c-e5b4-4e79-8c3e-1da8c48461e7'
        - name: AzureAd__InboundPolicies__0__SignedHttpRequestValidationPolicy
          value: '{"ValidateTs" : true, "ValidateM" : true, "ValidateU" : true, "ValidateP" : true }'
        - name: AzureAd__InboundPolicies__1__Label
          value: "Geneva Actions"
        - name: AzureAd__InboundPolicies__1__Authority
          value: "https://sts.windows.net/__tenantId__/"
        - name: AzureAd__InboundPolicies__1__AuthenticationSchemes__0
          value: "Bearer"
        - name: AzureAd__InboundPolicies__1__ValidAudiences__0
          value: 'https://management.azure.com'
        - name: AzureAd__InboundPolicies__1__ValidApplicationIds__0
          value: "__genevaActionsAppId__"
        - name: AllowedHosts
          value: "*"
        - name: Kestrel__Endpoints__Http__Url
          value: "http://0.0.0.0:8080"
        - name: Logging__LogLevel__Default
          value: "Information"
        - name: Logging__LogLevel__Microsoft
          value: "Information"
        - name: AzureAd__Logging__LogLevel
          value: "Information"
        - name: OTEL_EXPORTER_OTLP_ENDPOINT
          value: ""
        - name: OTEL_TRACES_EXPORTER
          value: ""
---
# Source: istio/charts/mise/templates/destinationrule.yaml
apiVersion: networking.istio.io/v1
kind: DestinationRule
metadata:
  name: mise
  namespace: 'mise'
spec:
  host: mise.mise.svc.cluster.local
  subsets:
  - name: v1
    labels:
      version: v1
  - name: v2
    labels:
      version: v2
---
# Source: istio/templates/strict_mtls.yml
apiVersion: security.istio.io/v1beta1
kind: PeerAuthentication
metadata:
  name: default
  namespace: 'aks-istio-system'
spec:
  mtls:
    mode: STRICT
---
# Source: istio/templates/envoy-stats.podmonitor.yml
apiVersion: monitoring.coreos.com/v1
kind: PodMonitor
metadata:
  name: envoy-stats
  namespace: 'aks-istio-system'
spec:
  jobLabel: app
  # The following limits - labelLimit, labelNameLengthLimit and labelValueLengthLimit should exist in the pod monitor CR
  # These ensure that the metrics don't get dropped because labels/labelnames/labelvalues exceed the limits supported by the processing pipeline
  labelLimit: 63
  labelNameLengthLimit: 511
  labelValueLengthLimit: 1023
  selector:
    matchLabels:
      security.istio.io/tlsMode: istio
  namespaceSelector:
    any: true
  podMetricsEndpoints:
  - interval: 15s
    path: /stats/prometheus
    port: http-envoy-prom
---
# Source: istio/templates/mise.serviceentry.yml
apiVersion: networking.istio.io/v1
kind: ServiceEntry
metadata:
  name: external-authz-http
  namespace: 'aks-istio-system'
spec:
  hosts:
  - "mise.mise.svc.cluster.local"
  endpoints:
  - address: "127.0.0.1"
  ports:
  - name: http
    number: 8080
    protocol: http
  resolution: STATIC
---
# Source: istio/templates/istiod.servicemonitor.yml
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: istiod
  namespace: 'aks-istio-system'
spec:
  jobLabel: app
  # The following limits - labelLimit, labelNameLengthLimit and labelValueLengthLimit should exist in the pod monitor CR
  # These ensure that the metrics don't get dropped because labels/labelnames/labelvalues exceed the limits supported by the processing pipeline
  labelLimit: 63
  labelNameLengthLimit: 511
  labelValueLengthLimit: 1023
  selector:
    matchExpressions:
    - key: app
      operator: In
      values:
      - istiod
  namespaceSelector:
    matchNames:
    - aks-istio-system
  endpoints:
  - interval: 15s
    port: http-monitoring
---
# Source: istio/templates/mesh-logging.telemetry.yml
apiVersion: telemetry.istio.io/v1
kind: Telemetry
metadata:
  name: mesh-logging
  namespace: 'aks-istio-system'
spec:
  accessLogging:
  - providers:
    - name: envoy
---
# Source: istio/charts/mise/templates/virtualservice.yaml
apiVersion: networking.istio.io/v1
kind: VirtualService
metadata:
  name: mise
  namespace: 'mise'
spec:
  hosts:
  - mise.mise.svc.cluster.local
  http:
  - route:
    - destination:
        host: mise.mise.svc.cluster.local
        subset: v1
      weight: 100
    - destination:
        host: mise.mise.svc.cluster.local
        subset: v2
      weight: 0

