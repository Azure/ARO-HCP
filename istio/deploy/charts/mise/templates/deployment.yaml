apiVersion: apps/v1
kind: Deployment
metadata:
  name: mise
  namespace: '{{ .Values.namespace }}'
spec:
  replicas: 2
  selector:
    matchLabels:
      app: mise
  template:
    metadata:
      labels:
        app: mise
    spec:
      topologySpreadConstraints:
      - maxSkew: 1
        topologyKey: '{{ if eq (int .Values.deployment.zoneCount) 0 }}kubernetes.azure.com/agentpool{{ else }}topology.kubernetes.io/zone{{ end }}'
        whenUnsatisfiable: ScheduleAnyway
        labelSelector:
          matchLabels:
            app: mise
      - maxSkew: 1
        topologyKey: kubernetes.io/hostname
        whenUnsatisfiable: ScheduleAnyway
        labelSelector:
          matchLabels:
            app: mise
      containers:
      - name: mise
        image: "{{ .Values.image.registry }}/{{ .Values.image.repository }}@{{ .Values.image.digest }}"
        ports:
        - containerPort: 8080
        livenessProbe:
          httpGet:
            path: /healthz
            port: 8080
        readinessProbe:
          httpGet:
            path: /readyz
            port: 8080
        env:
        - name: EnableInboundPolicyFilter
          value: "true"
        - name: AzureAd__Instance
          value: '{{ .Values.audit.adInstance }}'
        - name: AzureAd__ClientId
          value: '{{ .Values.audit.clientId }}'
        - name: AzureAd__TenantId
          value: '{{ .Values.audit.tenantId }}'
        - name: AzureAd__Audience
          value: "{{ .Values.audit.audience }}"
        - name: AzureAd__InboundPolicies__0__Label
          value: "{{ .Values.armPolicy.label }}"
        - name: AzureAd__InboundPolicies__0__Authority
          value: "{{ .Values.armPolicy.authority }}"
        - name: AzureAd__InboundPolicies__0__AuthenticationSchemes__0
          value: "PoP"
        - name: AzureAd__InboundPolicies__0__ValidAudiences__0
          value: '{{ .Values.armPolicy.audience }}'
        - name: AzureAd__InboundPolicies__0__ValidApplicationIds__0
          value: '{{ .Values.armPolicy.applicationId }}'
        - name: AzureAd__InboundPolicies__0__SignedHttpRequestValidationPolicy
          value: '{"ValidateTs" : true, "ValidateM" : true, "ValidateU" : true, "ValidateP" : true }'
        - name: AzureAd__InboundPolicies__1__Label
          value: "{{ .Values.genevaActionsPolicy.label }}"
        - name: AzureAd__InboundPolicies__1__Authority
          value: "{{ .Values.genevaActionsPolicy.authority }}"
        - name: AzureAd__InboundPolicies__1__AuthenticationSchemes__0
          value: "Bearer"
        - name: AzureAd__InboundPolicies__1__ValidAudiences__0
          value: '{{ .Values.genevaActionsPolicy.audience }}'
        - name: AzureAd__InboundPolicies__1__ValidApplicationIds__0
          value: "{{ .Values.genevaActionsPolicy.applicationId }}"
        - name: AzureAd__InboundPolicies__2__Label
          value: "{{ .Values.sessiongatePolicy.label }}"
        - name: AzureAd__InboundPolicies__2__Authority
          value: "{{ .Values.sessiongatePolicy.authority }}"
        - name: AzureAd__InboundPolicies__2__AuthenticationSchemes__0
          value: "Bearer"
        - name: AzureAd__InboundPolicies__2__ValidAudiences__0
          value: '{{ .Values.sessiongatePolicy.audience }}'
        - name: AllowedHosts
          value: "*"
        - name: Kestrel__Endpoints__Http__Url
          value: "http://0.0.0.0:8080"
        - name: Logging__LogLevel__Default
          value: "Information"
        - name: Logging__LogLevel__Microsoft
          value: "Information"
        - name: AzureAd__Logging__LogLevel
          value: "Information"
        - name: OTEL_EXPORTER_OTLP_ENDPOINT
          value: "{{ .Values.tracing.address }}"
        - name: OTEL_TRACES_EXPORTER
          value: "{{ .Values.tracing.exporter }}"
