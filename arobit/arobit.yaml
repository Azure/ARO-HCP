---
# Source: arobit/templates/serviceaccount.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: arobit-forwarder
  labels:
    helm.sh/chart: arobit-0.0.1
    app.kubernetes.io/name: arobit-forwarder
    app.kubernetes.io/instance: arobit
---
# Source: arobit/templates/forwarder-configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: arobit-forwarder
  labels:
    helm.sh/chart: arobit-0.0.1
    app.kubernetes.io/name: arobit-forwarder
    app.kubernetes.io/instance: arobit
data:
  fluent-bit.conf: |
    @INCLUDE /forwarder/etc/service.conf

    @INCLUDE /forwarder/etc/input.conf

    @INCLUDE /forwarder/etc/filter.conf@INCLUDE /forwarder/etc/output-mdsd.conf`
  filter-ocm.conf: |
    [FILTER]
        Name            rewrite_tag
        Alias           filter.namespace_router
        Match           kubernetes.var.log.containers.*
        Rule            $kubernetes['namespace_name'] ^ocm-.* ocm.logs false
        Rule            $kubernetes['namespace_name'] ^(?!ocm-).* other.logs false
        Emitter_Name    re_emitted
    
  filter.conf: |
    [FILTER]
        Name   lua
        Alias  lua.reassemble_cri
        Match  kubernetes.var.log.containers.*
        script /forwarder/etc/reassemble_cri.lua
        call   reassemble_cri
    
    [FILTER]
        Name                kubernetes
        Alias               filter.kubernetes
        Match               kubernetes.var.log.containers.*
        Kube_Tag_Prefix     kubernetes.var.log.containers.
        Annotations         Off
        K8S-Logging.Exclude On
    
  input.conf: |
    [INPUT]
        Name              tail
        Alias             tail.container
        Tag               kubernetes.*
        Path              /var/log/containers/*.log
        Exclude_Path      /var/log/containers/*log-tailer*,/var/log/containers/*geneva-logger*,/var/log/containers/*arobit*
        # For kubernetes version < 1.19.x, use 'docker' parser instead:
        # Parser            docker
        # Docker_Mode       On
        Parser            cri-o
        DB                /var/log/flb-tail.db
        DB.sync           normal
        DB.locking        true
        # The interval of refreshing the list of watched files in seconds.
        # (default: 60)
        Refresh_Interval  15
        # For new discovered files on start (without a database offset/position), read the content from the head of the file.
        # (default: off)
        Read_from_Head    On
        # Set the initial buffer size to read files data. This value is used to increase buffer size.
        # (default: 32K)
        Buffer_Chunk_Size 1M
        # Set the limit of the buffer size per monitored file. When a buffer needs to be increased (e.g: very long lines),
        # this value is used to restrict how much the memory buffer can grow.
        # (default: Buffer_Chunk_Size)
        Buffer_Max_Size   4M
        # When a monitored file reach it buffer capacity due to a very long line (Buffer_Max_Size), the default behavior is to stop monitoring that file.
        # Skip_Long_Lines alter that behavior and instruct Fluent Bit to skip long lines and continue processing other lines that fits into the buffer size.
        # (default: Off)
        Skip_Long_Lines   On
        # Set a limit of memory that Tail plugin can use when appending data to the Engine.
        # If the limit is reach, it will be paused; when the data is flushed it resumes.
        Mem_Buf_Limit     512M
        storage.type      filesystem
        # The new threaded mechanism allows input plugins to run in a separate thread which helps to desaturate the main pipeline
        Threaded          On
    
    [INPUT]
        Name              forward
        Alias             input.forward
        Listen            0.0.0.0
        Port              24224
        # By default, the buffer to store the incoming Forward messages, do not allocate the maximum memory allowed,
        # instead it allocate memory when is required. The rounds of allocations are set by Buffer_Chunk_Size.
        # (default: 32KB)
        Buffer_Chunk_Size 1M
        # Specify the maximum buffer memory size used to receive a Forward message.
        # (default: Buffer_Chunk_Size)
        Buffer_Max_Size   16M
        Mem_Buf_Limit     512M
    
    [INPUT]
        Name            fluentbit_metrics
        Alias           metrics.fluentbit
        Tag             metrics.fluentbit
        scrape_interval 15
    
    [INPUT]
        Name   opentelemetry
        Alias  otlp
        Listen 0.0.0.0
        Port   4318
    
  output-mdsd-ocm.conf: |
    # Forward OCM namespace logs (ocm-.* pattern) to another mdsd instance
    [OUTPUT]
        Name  forward
        Alias forward.mdsd.ocm
        Match ocm.logs
        Host  127.0.0.1
        Port  5002
        Tag   ocm.kubernetes
    
  output-mdsd.conf: |
    # Forward logs to mdsd instance (default port)
    [OUTPUT]
        Name  forward
        Alias forward.mdsd.other
        Match other.logs
        Host  127.0.0.1
        Port  5001
        Tag   kubernetes
    
    [OUTPUT]
        Name  prometheus_exporter
        Alias exporter.fluentbit
        Match metrics.fluentbit
        Host  0.0.0.0
        Port  2020
    
  output.conf: |
    [OUTPUT]
        Name       opentelemetry
        Match      *
        Host       ingest.observability
        Port       4318
        Traces_uri /v1/traces
    
    [OUTPUT]
        Name  prometheus_exporter
        Alias exporter.fluentbit
        Match metrics.fluentbit
        Host  0.0.0.0
        Port  2020
    
  parsers_custom.conf: |
    # Previously, docker parser would parse the container log as record["log"].
    # With the default cri parser, the container log will be parsed as record["message"].
    # For backward compat with docker implementation, use the following parser.
    [PARSER]
        Name        cri-o
        Format      regex
        Regex       ^(?<time>[^ ]+) (?<stream>stdout|stderr) (?<logtag>[^ ]*) (?<log>.*)$
        Time_Key    time
        Time_Format %Y-%m-%dT%H:%M:%S.%L%z
        Time_Keep   On
    
  reassemble_cri.lua: |
    local reassemble_state = {}
    function reassemble_cri(tag, timestamp, record)
      local reassemble_key = tag
      -- if partial line, accumulate
      if record.logtag == 'P' then
        reassemble_state[reassemble_key] = (reassemble_state[reassemble_key] or "") .. (record.log or "")
        return -1, 0, 0
      end
      -- otherwise, it's a full line, concatenate with accumulated partial lines if any
      record.log = (reassemble_state[reassemble_key] or "") .. (record.log or "")
      reassemble_state[reassemble_key] = nil
      return 1, timestamp, record
    end
    
  service.conf: |
    [SERVICE]
        Flush                     1
        Log_Level                 info
        Parsers_File              /fluent-bit/etc/parsers.conf
        Parsers_File              /forwarder/etc/parsers_custom.conf
        Plugins_File              /fluent-bit/etc/plugins.conf
        HTTP_Server               On
        storage.path              /var/log/flb-storage/
        # If the input plugin has enabled filesystem storage type, this property sets the maximum number of Chunks that can be up in memory.
        # (default: 128)
        storage.max_chunks_up     256
        # This option configure a hint of maximum value of memory to use when processing the backlog data.
        # (default: 5M)
        storage.backlog.mem_limit 256M
        storage.metrics           on
        # Based on the HC_Period, if the error number > HC_Errors_Count or the retry failure > HC_Retry_Failure_Count, fluent bit is considered as unhealthy.
        Health_Check              On
        HC_Errors_Count           5
        HC_Retry_Failure_Count    5
        HC_Period                 60
---
# Source: arobit/templates/forwarder-clusterrole.yaml
kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: arobit-forwarder
  labels:
    helm.sh/chart: arobit-0.0.1
    app.kubernetes.io/name: arobit-forwarder
    app.kubernetes.io/instance: arobit
rules:
  - apiGroups:
      - ""
    resources:
      - "namespaces"
      - "services"
      - "pods"
    verbs:
      - "get"
      - "watch"
      - "list"
---
# Source: arobit/templates/forwarder-clusterrolebinding.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: arobit-forwarder
  labels:
    helm.sh/chart: arobit-0.0.1
    app.kubernetes.io/name: arobit-forwarder
    app.kubernetes.io/instance: arobit
roleRef:
  kind: ClusterRole
  apiGroup: rbac.authorization.k8s.io
  name: arobit-forwarder
subjects:
  - kind: ServiceAccount
    name: arobit-forwarder
    namespace: mds
---
# Source: arobit/templates/forwarder-service.yaml
apiVersion: v1
kind: Service
metadata:
  name: arobit-forwarder
  labels:
    helm.sh/chart: arobit-0.0.1
    app.kubernetes.io/name: arobit-forwarder
    app.kubernetes.io/instance: arobit
    ## Istio Labels: https://istio.io/docs/ops/deployment/requirements/
    app: arobit-forwarder
spec:
  type: ClusterIP
  ports:
    - name: forward
      
      port: 24224
      protocol: TCP
      targetPort: forward
    - name: http
      
      port: 2020
      protocol: TCP
      targetPort: http
    - name: otlp-http
      
      port: 4318
      protocol: TCP
      targetPort: otlp-http
  selector:
    app.kubernetes.io/name: arobit-forwarder
    app.kubernetes.io/instance: arobit
---
# Source: arobit/templates/forwarder-daemonset.yaml
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: arobit-forwarder
  labels:
    helm.sh/chart: arobit-0.0.1
    app.kubernetes.io/name: arobit-forwarder
    app.kubernetes.io/instance: arobit
    ## Istio Labels: https://istio.io/docs/ops/deployment/requirements/
    app: arobit-forwarder
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: arobit-forwarder
      app.kubernetes.io/instance: arobit
  updateStrategy:
    type: RollingUpdate
  template:
    metadata:
      labels:
        helm.sh/chart: arobit-0.0.1
        app.kubernetes.io/name: arobit-forwarder
        app.kubernetes.io/instance: arobit
        app: arobit-forwarder
      annotations:
        checksum/config: 2eec7964754ea7cd8067bb24fdb03e247e7ca41cd115b6054dd07645e609fcd9
    spec:
      serviceAccountName: arobit-forwarder
      priorityClassName: ""
      securityContext:
        runAsGroup: 65532
        runAsUser: 65532
      shareProcessNamespace: true
      containers:
        - name: fluentbit
          image: mcr.microsoft.com/oss/fluent/fluent-bit@sha256:667535f49ba225d96395ec8df3dcf9cf5f946facdb69afe1d920ebba3e7a4265
          imagePullPolicy: IfNotPresent
          command:
            - /fluent-bit/bin/fluent-bit
          args:
            - -c
            - /forwarder/etc/fluent-bit.conf
          ports:
            - containerPort: 2020
              name: http
              protocol: TCP
            - containerPort: 4318
              name: otlp-http
              protocol: TCP
            - containerPort: 24224
              name: forward
              protocol: TCP
          livenessProbe:
            httpGet:
              path: /api/v1/health
              port: http
            initialDelaySeconds: 15
            periodSeconds: 15
            timeoutSeconds: 5
            successThreshold: 1
            failureThreshold: 6
          readinessProbe:
            httpGet:
              path: /api/v1/health
              port: http
            initialDelaySeconds: 15
            periodSeconds: 15
            timeoutSeconds: 5
            successThreshold: 1
            failureThreshold: 6
          resources:
            limits: {}
            requests: {}
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
              - ALL
            privileged: false
            runAsGroup: 0
            runAsUser: 0
          
          volumeMounts:
            - name: varlog
              mountPath: /var/log
            - name: varlibdockercontainers
              mountPath: /var/lib/docker/containers
              readOnly: true
            - name: flb-config
              mountPath: /forwarder/etc
              readOnly: true
        - name: mdsd
          image: linuxgeneva-microsoft.azurecr.io/genevamdsd@sha256:756d114bbaecec418139b53bdf634a9677f71c5c501a4af901246ef2f2c5d468
          imagePullPolicy: IfNotPresent
          command:
            - /start_mdsd.sh
          args:
            []
          ports:
          env:
            - name: MONITORING_CONFIG_VERSION
              value: 1
            - name: MONITORING_GCS_ACCOUNT
              value: placeholder
            - name: MONITORING_GCS_AUTH_ID
              value: foo
            - name: MONITORING_GCS_AUTH_ID_TYPE
              value: AuthKeyVault
            - name: MONITORING_GCS_ENVIRONMENT
              value: Test
            - name: MONITORING_GCS_NAMESPACE
              value: 
            - name: MONITORING_GCS_REGION
              value: westus3
            - name: "DOCKER_LOGGING"
              value: "true"
            - name: "FLUENTD_PORT"
              value: "5001"
            - name: "GCS_AUTOMATIC_CONFIGURATION"
              value: "1"
            - name: "GCS_AUTOMATIC_CONFIG_RUNTIME"
              value: "-A"
            - name: "MDSD_BACKPRESSURE_MONITOR_FREQ_SEC"
              value: "5"
            - name: "MDSD_BACKPRESSURE_MONITOR_MEMORY_THRESHOLD_IN_MB"
              value: "1000"
            - name: "MDSD_COMPRESSION_ALGORITHM"
              value: "lz4"
            - name: "MDSD_COMPRESSION_LEVEL"
              value: "4"
            - name: "MDSD_DAEMON_TEMPORARY_ELEVATION_DISABLED"
              value: "true"
            - name: "MDSD_DEBUG_LOG_FLAGS"
              value: "-T 0x00"
            - name: "MDSD_LOG_OPTIONS"
              value: "-D"
            - name: "MDSD_MSGPACK_ARRAY_SIZE_ITEMS"
              value: "10480000"
            - name: "MDSD_MSGPACK_MAP_SIZE_ITEMS"
              value: "10480000"
            - name: "MDSD_MSGPACK_NESTING_LEVEL"
              value: "10"
            - name: "MDSD_MSGPACK_SEND_ACK"
              value: "0"
            - name: "MDSD_MSGPACK_SORT_COLUMNS"
              value: "1"
            - name: "MDSD_PORT"
              value: "0"
            - name: "MDSD_TCMALLOC_RELEASE_FREQ_SEC"
              value: "1"
            - name: "MDSD_USE_LOCAL_PERSISTENCY"
              value: "false"
            - name: "MONITORING_GCS_CERT_CERTFILE"
              value: "/geneva/geneva_auth/gcscert.pem"
            - name: "MONITORING_GCS_CERT_KEYFILE"
              value: "/geneva/geneva_auth/gcskey.pem"
            - name: "MONITORING_GCS_EXACT_VERSION"
              value: "false"
            - name: "MONITORING_MAX_EVENT_RATE"
              value: "100000"
          lifecycle:
            preStop:
              exec:
                command:
                - /bin/sleep
                - "60"
          resources:
            limits: {}
            requests: {}
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              add: []
              drop: []
            privileged: false
            runAsGroup: 0
            runAsUser: 0
          
          volumeMounts:
            - name: mdsd-run
              mountPath: /var/run/mdsd/
            - name: cacrt-host
              mountPath: /etc/ssl/certs/ca-certificates.crt
              readOnly: true
            - mountPath: /geneva/geneva_auth/
              name: geneva-certs
              readOnly: true
      volumes:
        - name: sp-host
          hostPath:
            type: Directory
            path: /etc/kubernetes/
        - name: varlog
          hostPath:
            path: /var/log
        - name: varlibdockercontainers
          hostPath:
            path: /var/lib/docker/containers
        - name: cacrt-host
          hostPath:
            type: File
            path: /etc/ssl/certs/ca-certificates.crt
        - name: geneva-certs
          csi:
            driver: secrets-store.csi.k8s.io
            readOnly: true
            volumeAttributes:
              secretProviderClass: arobit-forwarder-secretprovider
          secret:
            secretName: arobit-forwarder
        - name: mdsd-run
          emptyDir: {}
        - name: flb-config
          configMap:
            name: arobit-forwarder
            defaultMode: 0755
---
# Source: arobit/templates/forwarder-secretprovider.yaml
apiVersion: secrets-store.csi.x-k8s.io/v1
kind: SecretProviderClass
metadata:
  name: arobit-forwarder-secretprovider
spec:
  provider: azure
  parameters:
    usePodIdentity: "false"
    useVMManagedIdentity: "false"
    clientID: 
    keyvaultName: "aro-hcp-dev-svc-kv"
    cloudName: ""
    cloudEnvFileName: ""
    objects:  |
      array:
        - |
          objectName: "rplogs"
          objectAlias: "gcscert.pem"
          objectType: secret
    tenantId: ""
