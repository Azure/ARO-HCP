---
# Source: velero-hcp-cli/templates/installer-rbac.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: velero-installer
  namespace: 'velero'
  annotations:
    azure.workload.identity/client-id: '__veleroMsiClientId__'
---
# Source: velero-hcp-cli/templates/serviceaccount.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  annotations:
    azure.workload.identity/client-id: '__veleroMsiClientId__'
  name: velero
  namespace: 'velero'
---
# Source: velero-hcp-cli/templates/credentials-secret.yaml
apiVersion: v1
kind: Secret
metadata:
  name: cloud-credentials-azure
  namespace: 'velero'
type: Opaque
stringData:
  cloud: |-
    AZURE_SUBSCRIPTION_ID=__subscriptionId__
    AZURE_TENANT_ID=__tenantId__
    AZURE_CLIENT_ID=__veleroMsiClientId__
    AZURE_RESOURCE_GROUP=hcp-underlay-dev-westus3-mgmt-1
    AZURE_CLOUD_NAME=AzurePublicCloud
---
# Source: velero-hcp-cli/templates/installer-rbac.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: velero-installer
rules:
- apiGroups: [""]
  resources:
  - namespaces
  - secrets
  - configmaps
  - serviceaccounts
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
- apiGroups: ["apps"]
  resources:
  - deployments
  - daemonsets
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
- apiGroups: ["rbac.authorization.k8s.io"]
  resources:
  - clusterroles
  - clusterrolebindings
  - roles
  - rolebindings
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete", "bind", "escalate"]
- apiGroups: ["velero.io"]
  resources:
  - backupstoragelocations
  - volumesnapshotlocations
  - backups
  - restores
  - schedules
  - backuprepositories
  - deletebackuprequests
  - downloadrequests
  - podvolumebackups
  - podvolumerestores
  - serverstatusrequests
  - datauploads
  - datadownloads
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
- apiGroups: ["snapshot.storage.k8s.io"]
  resources:
  - volumesnapshots
  - volumesnapshotcontents
  - volumesnapshotclasses
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
- apiGroups: ["apiextensions.k8s.io"]
  resources:
  - customresourcedefinitions
  verbs: ["get", "list", "watch", "create", "update", "patch"]
---
# Source: velero-hcp-cli/templates/velero-rbac.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: velero-cluster-role
  labels:
    component: velero
rules:
- apiGroups: [""]
  resources:
  - pods
  - persistentvolumes
  - persistentvolumeclaims
  - nodes
  - events
  - secrets
  - configmaps
  - serviceaccounts
  - namespaces
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete", "deletecollection"]
- apiGroups: ["apps"]
  resources:
  - deployments
  - daemonsets
  - replicasets
  - statefulsets
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
- apiGroups: ["batch"]
  resources:
  - jobs
  - cronjobs
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
- apiGroups: ["rbac.authorization.k8s.io"]
  resources:
  - clusterroles
  - clusterrolebindings
  - roles
  - rolebindings
  verbs: ["*"]
- apiGroups: ["rbac.authorization.k8s.io"]
  resources:
  - clusterroles
  - roles
  verbs: ["escalate", "bind"]
- apiGroups: ["velero.io"]
  resources: ["*"]
  verbs: ["*"]
- apiGroups: ["snapshot.storage.k8s.io"]
  resources:
  - volumesnapshots
  - volumesnapshotcontents
  - volumesnapshotclasses
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
- apiGroups: ["storage.k8s.io"]
  resources:
  - storageclasses
  - volumeattachments
  verbs: ["get", "list", "watch"]
- apiGroups: ["apiextensions.k8s.io"]
  resources:
  - customresourcedefinitions
  verbs: ["get", "list", "watch"]
- apiGroups: [""]
  resources:
  - services
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
- apiGroups: ["policy"]
  resources:
  - poddisruptionbudgets
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
- apiGroups: ["scheduling.k8s.io"]
  resources:
  - priorityclasses
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
- apiGroups: ["hypershift.openshift.io"]
  resources: ["*"]
  verbs: ["*"]
- apiGroups: ["cluster.x-k8s.io"]
  resources: ["*"]
  verbs: ["*"]
- apiGroups: ["addons.cluster.x-k8s.io"]
  resources: ["*"]
  verbs: ["*"]
- apiGroups: ["bootstrap.cluster.x-k8s.io"]
  resources: ["*"]
  verbs: ["*"]
- apiGroups: ["controlplane.cluster.x-k8s.io"]
  resources: ["*"]
  verbs: ["*"]
- apiGroups: ["exp.cluster.x-k8s.io"]
  resources: ["*"]
  verbs: ["*"]
- apiGroups: ["exp.infrastructure.cluster.x-k8s.io"]
  resources: ["*"]
  verbs: ["*"]
- apiGroups: ["machines.cluster.x-k8s.io"]
  resources: ["*"]
  verbs: ["*"]
- apiGroups: ["infrastructure.cluster.x-k8s.io"]
  resources: ["*"]
  verbs: ["*"]
- apiGroups: ["route.openshift.io"]
  resources: ["*"]
  verbs: ["*"]
- apiGroups: ["hive.openshift.io"]
  resources: ["*"]
  verbs: ["*"]
- apiGroups: ["secrets-store.csi.x-k8s.io"]
  resources: ["*"]
  verbs: ["*"]
- apiGroups: ["capi-provider.agent-install.openshift.io"]
  resources: ["*"]
  verbs: ["*"]
- apiGroups: ["coordination.k8s.io"]
  resources:
  - leases
  verbs: ["*"]
- apiGroups: ["certificates.hypershift.openshift.io"]
  resources: ["*"]
  verbs: ["*"]
- apiGroups: ["image.openshift.io"]
  resources: ["*"]
  verbs: ["*"]
- apiGroups: ["kubevirt.io"]
  resources: ["*"]
  verbs: ["*"]
- apiGroups: ["subresources.kubevirt.io"]
  resources: ["*"]
  verbs: ["*"]
- apiGroups: ["cdi.kubevirt.io"]
  resources: ["*"]
  verbs: ["*"]
- apiGroups: ["monitoring.coreos.com"]
  resources: ["*"]
  verbs: ["*"]
- apiGroups: ["monitoring.rhobs"]
  resources: ["*"]
  verbs: ["*"]
- apiGroups: ["discovery.k8s.io"]
  resources: ["*"]
  verbs: ["*"]
---
# Source: velero-hcp-cli/templates/installer-rbac.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: velero-installer
subjects:
- kind: ServiceAccount
  name: velero-installer
  namespace: 'velero'
roleRef:
  kind: ClusterRole
  name: velero-installer
  apiGroup: rbac.authorization.k8s.io
---
# Source: velero-hcp-cli/templates/velero-rbac.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: velero-cluster-role-binding
  labels:
    component: velero
subjects:
- kind: ServiceAccount
  name: velero
  namespace: 'velero'
roleRef:
  kind: ClusterRole
  name: velero-cluster-role
  apiGroup: rbac.authorization.k8s.io
---
# Source: velero-hcp-cli/templates/acrpullbinding.yaml
apiVersion: acrpull.microsoft.com/v1beta2
kind: AcrPullBinding
metadata:
  name: velero-pull-binding
  namespace: 'velero'
spec:
  acr:
    environment: PublicCloud
    server: 'arohcpsvcdev.azurecr.io'
    scope: 'repository:oadp/oadp-velero-rhel9:pull repository:oadp/oadp-velero-plugin-for-microsoft-azure-rhel9:pull repository:oadp/oadp-hypershift-velero-plugin-rhel9:pull'
  auth:
    workloadIdentity:
      serviceAccountRef: velero
      clientID: '__imagePullerMsiClientId__'
      tenantID: '__imagePullerMsiTenantId__'
  serviceAccountName: velero
---
# Source: velero-hcp-cli/templates/node-agent-podmonitor.yaml
apiVersion: monitoring.coreos.com/v1
kind: PodMonitor
metadata:
  name: node-agent
  namespace: 'velero'
spec:
  selector:
    matchLabels:
      name: node-agent
  namespaceSelector:
    matchNames:
    - 'velero'
  podMetricsEndpoints:
  - path: /metrics
    port: metrics
    scheme: http
    interval: 30s
---
# Source: velero-hcp-cli/templates/velero-podmonitor.yaml
apiVersion: monitoring.coreos.com/v1
kind: PodMonitor
metadata:
  name: velero
  namespace: 'velero'
spec:
  selector:
    matchLabels:
      deploy: velero
  namespaceSelector:
    matchNames:
    - 'velero'
  podMetricsEndpoints:
  - path: /metrics
    port: metrics
    scheme: http
    interval: 30s
---
# Source: velero-hcp-cli/templates/volumesnapshotclass.yaml
apiVersion: snapshot.storage.k8s.io/v1
kind: VolumeSnapshotClass
metadata:
  name: azure-disk-snapclass
  labels:
    velero.io/csi-volumesnapshot-class: "true"
driver: disk.csi.azure.com
deletionPolicy: Retain
parameters:
  incremental: "true"

---
# Source: velero-hcp-cli/templates/kustomize-patch.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: velero-kustomize-patch
  namespace: 'velero'
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "0"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
data:
  kustomization.yaml: |
    resources:
    - velero.yaml
    patchesStrategicMerge:
    - scheduling-patch.yaml
  scheduling-patch.yaml: |
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: velero
      namespace: velero
    spec:
      template:
        spec:
          nodeSelector:
            aro-hcp.azure.com/role: infra
          tolerations:
          - key: "infra"
            operator: "Equal"
            value: "true"
            effect: "NoSchedule"
---
# Source: velero-hcp-cli/templates/install-job.yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: velero-install
  namespace: 'velero'
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "1"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  activeDeadlineSeconds: 1800
  backoffLimit: 3
  template:
    metadata:
      labels:
        azure.workload.identity/use: "true"
    spec:
      serviceAccountName: velero-installer
      nodeSelector:
        aro-hcp.azure.com/role: infra
      tolerations:
        - effect: NoSchedule
          key: infra
          operator: Equal
          value: "true"
      initContainers:
      - name: generate-manifest
        image: "arohcpsvcdev.azurecr.io/oadp/oadp-velero-rhel9@sha256:1234567890"
        imagePullPolicy: IfNotPresent
        command:
        - /bin/sh
        - -c
        - |
          set -e
          echo "Generating Velero manifest..."

          ./velero install \
            --namespace velero \
            --provider azure \
            --plugins arohcpsvcdev.azurecr.io/oadp/oadp-velero-plugin-for-microsoft-azure-rhel9@sha256:1234567890,arohcpsvcdev.azurecr.io/oadp/oadp-hypershift-velero-plugin-rhel9@sha256:1234567890 \
            --bucket backups \
            --prefix velero \
            --secret-file /credentials/cloud \
            --service-account-name velero \
            --pod-labels azure.workload.identity/use=true \
            --use-node-agent \
            --features EnableCSI \
            --uploader-type kopia \
            --backup-location-config useAAD="true",resourceGroup=hcp-underlay-dev-westus3-mgmt-1,storageAccount=__storageAccountName__,subscriptionId=__subscriptionId__ \
            --snapshot-location-config subscriptionId=__subscriptionId__ \
            --image arohcpsvcdev.azurecr.io/oadp/oadp-velero-rhel9@sha256:1234567890 \
            --dry-run -o yaml > /manifest/velero.yaml

          echo "Manifest generated successfully."
          cat /manifest/velero.yaml
        volumeMounts:
        - name: credentials
          mountPath: /credentials
          readOnly: true
        - name: manifest
          mountPath: /manifest
      containers:
      - name: apply-manifest
        image: "mcr.microsoft.com/aks/command/runtime@sha256:1234567890"
        imagePullPolicy: IfNotPresent
        command:
        - /bin/bash
        - -c
        - |
          set -e
          echo "Setting up kustomize overlay..."
          cp /kustomize/kustomization.yaml /tmp/
          cp /kustomize/scheduling-patch.yaml /tmp/

          echo "Patching long container names in manifest..."
          manifest=$(cat /manifest/velero.yaml)
          manifest="${manifest//redhat-user-workloads-ocp-art-tenant-oadp-hypershift-oadp-plugin-main/oadp-hypershift-plugin}"
          echo "$manifest" > /tmp/velero.yaml

          echo "Applying Velero manifest with kustomize..."
          kubectl kustomize /tmp | kubectl apply -f -

          echo "Velero manifest applied. Verifying deployment..."
          kubectl rollout status deployment/velero -n velero --timeout=300s

          echo "Verifying node-agent daemonset..."
          kubectl rollout status daemonset/node-agent -n velero --timeout=300s

          echo "Velero installation verified successfully."
        volumeMounts:
        - name: manifest
          mountPath: /manifest
          readOnly: true
        - name: kustomize
          mountPath: /kustomize
          readOnly: true
      volumes:
      - name: credentials
        secret:
          secretName: cloud-credentials-azure
      - name: manifest
        emptyDir: {}
      - name: kustomize
        configMap:
          name: velero-kustomize-patch
      restartPolicy: Never
