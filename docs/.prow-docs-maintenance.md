# Prow Documentation Maintenance Guide

This file contains information for maintaining `prow.md` documentation.

## Sources of Truth

### Job Definitions (Generated - DO NOT EDIT)

These files are auto-generated and should NOT be edited directly:

- **Presubmit Jobs**: https://github.com/openshift/release/blob/master/ci-operator/jobs/Azure/ARO-HCP/Azure-ARO-HCP-main-presubmits.yaml
- **Periodic Jobs**: https://github.com/openshift/release/blob/master/ci-operator/jobs/Azure/ARO-HCP/Azure-ARO-HCP-main-periodics.yaml

### Job Configurations (Edit These)

These are the source configuration files that generate the job definitions:

- **Main Config**: https://github.com/openshift/release/blob/master/ci-operator/config/Azure/ARO-HCP/Azure-ARO-HCP-main.yaml
  - Contains: presubmit and postsubmit job configs
  - Key fields: `tests[].as` (job name), `tests[].always_run`, `tests[].optional`

- **Periodic Config**: https://github.com/openshift/release/blob/master/ci-operator/config/Azure/ARO-HCP/Azure-ARO-HCP-main__periodic.yaml
  - Contains: periodic job configs
  - Key fields: `tests[].as` (job name), `tests[].cron` (schedule)

- **Image Updater Config**: https://github.com/openshift/release/blob/master/ci-operator/config/Azure/ARO-HCP/Azure-ARO-HCP-main__image-updater.yaml
  - Contains: image updater job configs

- **Config README**: https://github.com/openshift/release/blob/master/ci-operator/config/Azure/ARO-HCP/README.md
  - Contains: instructions for adding/modifying jobs

### EV2 Integration Configuration

Located in this repository:

- **EV2 Config**: `../config/config.msft.clouds-overlay.yaml`
  - Contains: `prowJobName` mappings for each environment
  - Key sections:
    - `clouds.public.environments.int.defaults.e2e` - Integration environment config
    - `clouds.public.environments.stg.defaults.e2e` - Stage environment config
    - `clouds.public.environments.prod.defaults.e2e` - Production environment config
  - Fields: `e2e.regionTest.prowJobName`, `e2e.regionTest.gatePromotion`

- **E2E Pipeline**: `../test/e2e-pipeline.yaml`
  - Contains: How E2E tests reference Prow job names
  - Key variable: `PROW_JOB_NAME` from `e2e.regionTest.prowJobName`

## How to Update Documentation

### Adding a New Presubmit Job

1. Find job details from sources:
   - [Generated presubmit YAML](https://github.com/openshift/release/blob/master/ci-operator/jobs/Azure/ARO-HCP/Azure-ARO-HCP-main-presubmits.yaml) - for job name, status
   - [Prow dashboard](https://prow.ci.openshift.org/?repo=Azure%2FARO-HCP) - to verify job runs
   - [Step registry](https://steps.ci.openshift.org/) - for test details (use `test` name from config, not full job name)

2. Add entry to Quick Reference table in `prow.md`

3. Add detailed job section with:
   - Job name linked to Prow dashboard
   - Status (from `always_run` and `optional` fields)
   - Step Registry link (if applicable - use test name from `tests[].as` field with appropriate variant parameter)
   - Purpose (describe what the job does and why it exists for ARO HCP)

### Adding a New Periodic Job

1. Find job details from sources:
   - [Generated periodic YAML](https://github.com/openshift/release/blob/master/ci-operator/jobs/Azure/ARO-HCP/Azure-ARO-HCP-main-periodics.yaml) - for job name, schedule
   - [Prow dashboard](https://prow.ci.openshift.org/?repo=Azure%2FARO-HCP&job=periodic-*) - to verify job runs
   - [Step registry](https://steps.ci.openshift.org/) - for test details (requires `variant=periodic` or `variant=image-updater` parameter)

2. Add to appropriate subsection in `prow.md` (Image Updater Tooling, Resource Group Cleanup, or Periodic E2E Tests)

3. Add detailed job section with:
   - Job name linked to Prow dashboard
   - Schedule in cron format
   - Step Registry link with correct variant parameter
   - Purpose (describe what the job does and why it runs on this schedule)

### Updating Job Triggers or Status

1. Check the [source config YAML](https://github.com/openshift/release/tree/master/ci-operator/config/Azure/ARO-HCP) in openshift/release repository
2. Update the Quick Reference table in `prow.md`
3. Update the detailed job section
4. Keep status descriptions consistent:
   - "Always runs (required)" - `always_run: true`, `optional: false`
   - "Always runs, but optional (does not block merge)" - `always_run: true`, `optional: true`
   - "Optional (runs only when triggered)" - `always_run: false`, `optional: true`

### Updating EV2 Integration Info

1. Check `../config/config.msft.clouds-overlay.yaml` for:
   - Current `prowJobName` mappings
   - `gatePromotion` settings
   - Any new environments

2. Update the "EV2 Pipeline Integration" section with:
   - Configuration file references with line numbers
   - Environment-specific Prow job mappings
   - Promotion gating information

## Special Notes

### Integration Periodic Job Schedule

The `periodic-ci-Azure-ARO-HCP-main-periodic-integration-e2e-parallel` job has a placeholder schedule (`0 0 1 1 *` - January 1st) because it's actually triggered by EV2 pipeline after Int promotions, not on a regular schedule.

### Job Name Patterns

- Presubmit jobs: `pull-ci-Azure-ARO-HCP-main-<test-name>`
- Periodic jobs: `periodic-ci-Azure-ARO-HCP-main-<test-name>`
- Image updater: `periodic-ci-Azure-ARO-HCP-main-image-updater-<test-name>`

### Prow Dashboard Links

Job dashboard URLs follow this pattern:
```
https://prow.ci.openshift.org/?job=<job-name>
```

Individual job run URLs:
```
https://prow.ci.openshift.org/prowjob?prowjob=<prowjob-id>
```

### Step Registry Links

Step registry URLs show the detailed steps and configuration for each test. They follow this pattern:
```
https://steps.ci.openshift.org/job?org=Azure&repo=ARO-HCP&branch=main&test=<test-name>
```

Where `<test-name>` is the value from the `tests[].as` field in the job configuration (not the full job name). For example:
- Job name: `pull-ci-Azure-ARO-HCP-main-e2e-parallel`
- Test name: `e2e-parallel`
- Step registry URL: `https://steps.ci.openshift.org/job?org=Azure&repo=ARO-HCP&branch=main&test=e2e-parallel`

## Quick Commands

### Fetch Latest Job Configs

```bash
# Presubmit jobs
curl -s https://raw.githubusercontent.com/openshift/release/master/ci-operator/jobs/Azure/ARO-HCP/Azure-ARO-HCP-main-presubmits.yaml

# Periodic jobs
curl -s https://raw.githubusercontent.com/openshift/release/master/ci-operator/jobs/Azure/ARO-HCP/Azure-ARO-HCP-main-periodics.yaml

# Main config
curl -s https://raw.githubusercontent.com/openshift/release/master/ci-operator/config/Azure/ARO-HCP/Azure-ARO-HCP-main.yaml

# Periodic config
curl -s https://raw.githubusercontent.com/openshift/release/master/ci-operator/config/Azure/ARO-HCP/Azure-ARO-HCP-main__periodic.yaml
```

### Check EV2 Config

```bash
# View EV2 Prow job mappings (from repo root)
grep -A 5 "prowJobName:" config/config.msft.clouds-overlay.yaml
```

## Validation Checklist

Before finalizing documentation updates:

- [ ] All job names match the generated YAML exactly
- [ ] Trigger commands are correct (check `trigger` field)
- [ ] Always run and optional status are accurate
- [ ] Environment/region information is included where applicable
- [ ] Quick Reference table is updated
- [ ] Prow dashboard links are correct
- [ ] Step Registry links are included for all jobs (using test name from `tests[].as` field)
- [ ] Markdown linting passes (blank lines around lists/code blocks, language identifiers on code blocks)
- [ ] No duplicate headings (use descriptive prefixes like "Periodic Integration E2E")
- [ ] Special notes about placeholder schedules are included where relevant
