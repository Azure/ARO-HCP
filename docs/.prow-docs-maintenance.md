# Prow Documentation Maintenance Guide

This file contains information for maintaining `prow.md` documentation.

## Sources of Truth

### Job Definitions (Generated - DO NOT EDIT)

These files are auto-generated and should NOT be edited directly:

- **Presubmit Jobs**: https://github.com/openshift/release/blob/master/ci-operator/jobs/Azure/ARO-HCP/Azure-ARO-HCP-main-presubmits.yaml
- **Periodic Jobs**: https://github.com/openshift/release/blob/master/ci-operator/jobs/Azure/ARO-HCP/Azure-ARO-HCP-main-periodics.yaml

### Job Configurations (Edit These)

These are the source configuration files that generate the job definitions:

- **Main Config**: https://github.com/openshift/release/blob/master/ci-operator/config/Azure/ARO-HCP/Azure-ARO-HCP-main.yaml
  - Contains: presubmit and postsubmit job configs
  - Key fields: `tests[].as` (job name), `tests[].always_run`, `tests[].optional`

- **Periodic Config**: https://github.com/openshift/release/blob/master/ci-operator/config/Azure/ARO-HCP/Azure-ARO-HCP-main__periodic.yaml
  - Contains: periodic job configs
  - Key fields: `tests[].as` (job name), `tests[].cron` (schedule)

- **Image Updater Config**: https://github.com/openshift/release/blob/master/ci-operator/config/Azure/ARO-HCP/Azure-ARO-HCP-main__image-updater.yaml
  - Contains: image updater job configs

- **Config README**: https://github.com/openshift/release/blob/master/ci-operator/config/Azure/ARO-HCP/README.md
  - Contains: instructions for adding/modifying jobs

### EV2 Integration Configuration

Located in this repository:

- **EV2 Config**: `/Users/rael/Code/Azure/ARO-HCP/config/config.msft.clouds-overlay.yaml`
  - Contains: `prowJobName` mappings for each environment
  - Key sections:
    - Line ~15: Integration environment config
    - Line ~117: Stage environment config
    - Line ~218: Production environment config
  - Fields: `e2e.regionTest.prowJobName`, `e2e.regionTest.gatePromotion`

- **E2E Pipeline**: `/Users/rael/Code/Azure/ARO-HCP/test/e2e-pipeline.yaml`
  - Contains: How E2E tests reference Prow job names
  - Key variable: `PROW_JOB_NAME` from `e2e.regionTest.prowJobName`

## How to Update Documentation

### Adding a New Presubmit Job

1. Check the generated presubmit YAML for the new job details:
   - Job name (from `name` field)
   - Trigger command (from `trigger` field)
   - Always run status (from `always_run` field)
   - Optional status (from `optional` field)
   - Environment/region (from `spec.extra_refs` or test config)

2. Add entry to the Quick Reference table in `prow.md`

3. Add detailed section following the existing pattern:
   - Job name with Prow dashboard link
   - Trigger command
   - Status (always_run + optional/required)
   - Purpose
   - Environment/region if applicable
   - Cluster if specified

### Adding a New Periodic Job

1. Check the generated periodic YAML for the new job details:
   - Job name (from `name` field)
   - Schedule (from `cron` field or `interval` field)
   - Environment/region (from test config)

2. Add to appropriate subsection in `prow.md`:
   - Image Updater Tooling
   - Resource Group Cleanup
   - Periodic E2E Tests

3. Include:
   - Job name with Prow dashboard link
   - Schedule in cron format with description
   - Purpose
   - Environment/region if applicable

### Updating Job Triggers or Status

1. Check the source config YAML in `ci-operator/config/Azure/ARO-HCP/`
2. Update the Quick Reference table
3. Update the detailed job section
4. Keep status descriptions consistent:
   - "Always runs (required)" - `always_run: true`, `optional: false`
   - "Always runs, but optional (does not block merge)" - `always_run: true`, `optional: true`
   - "Optional (runs only when triggered)" - `always_run: false`, `optional: true`

### Updating EV2 Integration Info

1. Check `/Users/rael/Code/Azure/ARO-HCP/config/config.msft.clouds-overlay.yaml` for:
   - Current `prowJobName` mappings
   - `gatePromotion` settings
   - Any new environments

2. Update the "EV2 Pipeline Integration" section with:
   - Configuration file references with line numbers
   - Environment-specific Prow job mappings
   - Promotion gating information

## Special Notes

### Integration Periodic Job Schedule

The `periodic-ci-Azure-ARO-HCP-main-periodic-integration-e2e-parallel` job has a placeholder schedule (`0 0 1 1 *` - January 1st) because it's actually triggered by EV2 pipeline after Int promotions, not on a regular schedule.

### Job Name Patterns

- Presubmit jobs: `pull-ci-Azure-ARO-HCP-main-<test-name>`
- Periodic jobs: `periodic-ci-Azure-ARO-HCP-main-<test-name>`
- Image updater: `periodic-ci-Azure-ARO-HCP-main-image-updater-<test-name>`

### Prow Dashboard Links

Job dashboard URLs follow this pattern:
```
https://prow.ci.openshift.org/?job=<job-name>
```

Individual job run URLs:
```
https://prow.ci.openshift.org/prowjob?prowjob=<prowjob-id>
```

## Quick Commands

### Fetch Latest Job Configs

```bash
# Presubmit jobs
curl -s https://raw.githubusercontent.com/openshift/release/master/ci-operator/jobs/Azure/ARO-HCP/Azure-ARO-HCP-main-presubmits.yaml

# Periodic jobs
curl -s https://raw.githubusercontent.com/openshift/release/master/ci-operator/jobs/Azure/ARO-HCP/Azure-ARO-HCP-main-periodics.yaml

# Main config
curl -s https://raw.githubusercontent.com/openshift/release/master/ci-operator/config/Azure/ARO-HCP/Azure-ARO-HCP-main.yaml

# Periodic config
curl -s https://raw.githubusercontent.com/openshift/release/master/ci-operator/config/Azure/ARO-HCP/Azure-ARO-HCP-main__periodic.yaml
```

### Check EV2 Config

```bash
# View EV2 Prow job mappings
grep -A 5 "prowJobName:" /Users/rael/Code/Azure/ARO-HCP/config/config.msft.clouds-overlay.yaml
```

## Validation Checklist

Before finalizing documentation updates:

- [ ] All job names match the generated YAML exactly
- [ ] Trigger commands are correct (check `trigger` field)
- [ ] Always run and optional status are accurate
- [ ] Environment/region information is included where applicable
- [ ] Quick Reference table is updated
- [ ] Prow dashboard links are correct
- [ ] Markdown linting passes (blank lines around lists/code blocks, language identifiers on code blocks)
- [ ] No duplicate headings (use descriptive prefixes like "Periodic Integration E2E")
- [ ] Special notes about placeholder schedules are included where relevant
