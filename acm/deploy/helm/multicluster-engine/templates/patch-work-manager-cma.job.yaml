apiVersion: batch/v1
kind: Job
metadata:
    name: patch-work-manager-cma
    namespace: '{{ .Release.Namespace }}'
spec:
    activeDeadlineSeconds: 1800
    backoffLimit: 3
    template:
        spec:
            containers:
                - command:
                    - /bin/sh
                    - -c
                    - |
                      echo "Waiting for ClusterManagementAddOn 'work-manager' to exist..."
                      until kubectl get clustermanagementaddon work-manager; do
                        sleep 5
                      done
                      echo "ClusterManagementAddOn 'work-manager' found. Patching..."
                      kubectl patch clustermanagementaddon work-manager --type merge -p '{"spec":{"supportedConfigs":[{"defaultConfig":{"name":"addon-hosted-config","namespace":"multicluster-engine"},"group":"addon.open-cluster-management.io","resource":"addondeploymentconfigs"}]}}'
                      echo "Patch applied successfully."
                  image: mcr.microsoft.com/aks/command/runtime:master.240118.1
                  name: patch-work-manager-cma
            restartPolicy: Never
            serviceAccountName: cluster-manager
    ttlSecondsAfterFinished: 60
