#
# Purpose: Manage regional resources for ARO HCP shared by SC and MC
# Managed Resources:
# * regional SVC and CX DNS zones and delegates them to the global ones
# * Eventgrid Namespaces MQTT for Maestro
# * regional replication for the OCP and SVC ACRs
# * regional Azure Monitor Workspace & linking into global Grafana
# * regional Azure Log Analytics Workspace
#
$schema: "pipeline.schema.v1"
serviceGroup: Microsoft.Azure.ARO.HCP.Region
rolloutName: Region Rollout
resourceGroups:
- name: global
  resourceGroup: '{{ .global.rg }}'
  subscription: '{{ .global.subscription.key }}'
  steps:
  # Query parameters from global deployment, e.g. DNS hzone and ACR resource IDs
  - name: output
    action: ARM
    template: templates/output-global.bicep
    parameters: configurations/output-global.tmpl.bicepparam
    deploymentLevel: ResourceGroup
    outputOnly: true
  - name: ocp-acr-replication
    action: Shell
    command: ./manage-acr-replication.sh
    workingDir: ./scripts
    dryRun:
      variables:
      - name: DRY_RUN
        value: "true"
    variables:
    - name: ACR_NAME
      configRef: acr.ocp.name
    - name: REPLICATION_REGION
      configRef: region
    shellIdentity:
      input:
        resourceGroup: global
        step: output
        name: globalMSIId
  - name: svc-acr-replication
    action: Shell
    command: ./manage-acr-replication.sh
    workingDir: ./scripts
    variables:
    - name: ACR_NAME
      configRef: acr.svc.name
    - name: REPLICATION_REGION
      configRef: region
    dryRun:
      variables:
      - name: DRY_RUN
        value: "true"
    shellIdentity:
      input:
        resourceGroup: global
        step: output
        name: globalMSIId
  - name: add-grafana-datasource
    action: Shell
    omitFromServiceGroupCompletion: true
    command: make build && ./grafanactl modify datasource add
    workingDir: ../tooling/grafanactl
    automatedRetry:
      errorContainsAny:
      - "is invalid as it is being provisioned with state"
      - "503 Server Error: Service Unavailable for url"
      - "(CreateOrUpdateConflict) Operation conflict occurred for workspace"
      - "InvalidMonitorAccountIntegration"
      maximumRetryCount: 5
      durationBetweenRetries: 2m
    dryRun:
      variables:
      - name: DRY_RUN
        value: "true"
    variables:
    - name: GRAFANA_RESOURCE_ID
      input:
        resourceGroup: global
        step: output
        name: grafanaResourceId
    - name: MONITOR_WORKSPACE_ID
      input:
        resourceGroup: regional
        step: output
        name: allWorkspaceIds
    shellIdentity:
      input:
        resourceGroup: global
        step: output
        name: globalMSIId
- name: regional
  resourceGroup: '{{ .regionRG }}'
  subscription: '{{ .svc.subscription.key }}'
  steps:
  - name: rpRegistration
    action: ProviderFeatureRegistration
    providerConfigRef: svc.subscription.providers
    identityFrom:
      resourceGroup: global
      step: output
      name: globalMSIId
    dependsOn:
    - resourceGroup: global
      step: svc-acr-replication
    - resourceGroup: global
      step: ocp-acr-replication
  - name: infra
    action: ARM
    template: templates/region.bicep
    parameters: configurations/region.tmpl.bicepparam
    deploymentLevel: ResourceGroup
    variables:
    - name: globalMSIId
      input:
        resourceGroup: global
        step: output
        name: globalMSIId
    - name: cxParentZoneResourceId
      input:
        resourceGroup: global
        step: output
        name: cxParentZoneResourceId
    - name: svcParentZoneResourceId
      input:
        resourceGroup: global
        step: output
        name: svcParentZoneResourceId
    - name: grafanaResourceId
      input:
        resourceGroup: global
        step: output
        name: grafanaResourceId
    dependsOn:
    - resourceGroup: regional
      step: rpRegistration
  - name: housekeeping
    action: Shell
    command: ./regional-housekeeping.sh
    workingDir: ./scripts
    dryRun:
      variables:
      - name: DRY_RUN
        value: "true"
    variables:
    - name: REGIONAL_RESOURCE_GROUP
      configRef: regionRG
    dependsOn:
    - resourceGroup: regional
      step: infra
    shellIdentity:
      input:
        resourceGroup: global
        step: output
        name: globalMSIId
  - name: output
    action: ARM
    template: templates/output-region.bicep
    parameters: configurations/output-region.tmpl.bicepparam
    deploymentLevel: ResourceGroup
    outputOnly: true
    dependsOn:
    - resourceGroup: regional
      step: housekeeping
