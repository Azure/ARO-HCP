apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  labels:
    app.kubernetes.io/name: kube-prometheus
    app.kubernetes.io/part-of: kube-prometheus
    prometheus: k8s
    role: alert-rules
  name: aro-hcp-kubernetes-overrides
  namespace: monitoring
spec:
  groups:
  - name: kubernetes-apps
    rules:
    - alert: KubeDeploymentReplicasMismatch
      annotations:
        description: Deployment {{ $labels.namespace }}/{{ $labels.deployment }} has not matched the expected number of replicas for longer than 30 minutes. Missing {{ $value | humanizePercentage }} of replicas.
        runbook_url: https://runbooks.prometheus-operator.dev/runbooks/kubernetes/kubedeploymentreplicasmismatch
        summary: Deployment has not matched the expected number of replicas.
      expr: |
        (
          (
            kube_deployment_spec_replicas{job="kube-state-metrics"}
              -
            kube_deployment_status_replicas_available{job="kube-state-metrics"}
          ) / kube_deployment_spec_replicas{job="kube-state-metrics"} > 0.5
        ) and (
          kube_deployment_spec_replicas{job="kube-state-metrics"} > 0
        ) and (
          changes(kube_deployment_status_replicas_updated{job="kube-state-metrics"}[10m])
            ==
          0
        )
      for: 30m
      labels:
        severity: warning
    - alert: KubeContainerWaiting
      annotations:
        description: pod/{{ $labels.pod }} in namespace {{ $labels.namespace }} on container {{ $labels.container}} has been in waiting state ({{ $labels.reason }}) for longer than 1 hour.
        runbook_url: https://runbooks.prometheus-operator.dev/runbooks/kubernetes/kubecontainerwaiting
        summary: Pod container waiting longer than 1 hour
      expr: |
        sum by (namespace, pod, container, cluster, reason) (
          kube_pod_container_status_waiting_reason{
            job="kube-state-metrics",
            reason=~"ImagePullBackOff|ErrImagePull|CreateContainerConfigError|InvalidImageName"
          }
        ) > 0
        unless on (namespace, pod, cluster)
        kube_pod_owner{owner_kind=~"Job|CronJob"}
      for: 1h
      labels:
        severity: warning
