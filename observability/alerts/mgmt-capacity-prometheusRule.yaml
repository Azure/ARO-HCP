apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: mgmt-capacity-monitoring-rules
  namespace: monitoring
spec:
  groups:
  - name: mgmt-capacity.rules
    rules:
    # NOTE: Temporarily set to 'info' (Sev 4) during testing period to prevent incident spamming.
    # Will be changed to 'warning' (Sev 3) after alert behavior is validated in production.
    - alert: MgmtClusterHCPCapacityWarning
      annotations:
        description: Management cluster {{ $labels.cluster }} is at {{ $value | humanizePercentage }} of its HCP capacity (60 HCP limit). Current count exceeds warning threshold of 60%.
        runbook_url: https://aka.ms/arohcp-runbook/mgmt-cluster-capacity
        summary: Management cluster HCP capacity is approaching limit (60% threshold).
      expr: |
        (
          count(kube_namespace_labels{namespace=~"^ocm-[^-]+-[^-]+$"}) by (cluster)
          / 60
        ) > 0.60
      for: 15m
      labels:
        severity: info
    # NOTE: Temporarily set to 'info' (Sev 4) during testing period to prevent incident spamming.
    # Will be changed to 'critical' (Sev 2) after alert behavior is validated in production.
    - alert: MgmtClusterHCPCapacityCritical
      annotations:
        description: Management cluster {{ $labels.cluster }} is at {{ $value | humanizePercentage }} of its HCP capacity (60 HCP limit). Current count exceeds critical threshold of 85%. Immediate action required to provision additional management cluster capacity.
        runbook_url: https://aka.ms/arohcp-runbook/mgmt-cluster-capacity
        summary: Management cluster HCP capacity is critically high (85% threshold).
      expr: |
        (
          count(kube_namespace_labels{namespace=~"^ocm-[^-]+-[^-]+$"}) by (cluster)
          / 60
        ) > 0.85
      for: 5m
      labels:
        severity: info
