apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: hcp-kms-recording-rules
  namespace: prometheus
spec:
  groups:
  - name: hcp-kms-recording-rules
    rules:
    # Long-window averages for slow-burn alerts
    - record: hostedClusterAPI_kubeapiserver_available:ratio_avg_30d
      expr: avg_over_time(hostedClusterAPI_kubeapiserver_available{status="True"}[30d])
    - record: hostedClusterAPI_kubeapiserver_available:ratio_avg_7d
      expr: avg_over_time(hostedClusterAPI_kubeapiserver_available{status="True"}[7d])
    - record: hostedClusterAPI_kubeapiserver_available:ratio_avg_1d
      expr: avg_over_time(hostedClusterAPI_kubeapiserver_available{status="True"}[1d])
    - record: hostedClusterAPI_kubeapiserver_available:ratio_avg_3d
      expr: avg_over_time(hostedClusterAPI_kubeapiserver_available{status="True"}[3d])
    # Short-window sum_over_time for burn-rate calculations
    - record: hostedClusterAPI_kubeapiserver_available:sum_over_time_30m
      expr: sum by (name, namespace, _id, cluster) (sum_over_time(hostedClusterAPI_kubeapiserver_available{status="True"}[30m]))
    - record: hostedClusterAPI_kubeapiserver_available:sum_over_time_1h
      expr: sum by (name, namespace, _id, cluster) (sum_over_time(hostedClusterAPI_kubeapiserver_available{status="True"}[1h]))
    - record: hostedClusterAPI_kubeapiserver_available:sum_over_time_2h
      expr: sum by (name, namespace, _id, cluster) (sum_over_time(hostedClusterAPI_kubeapiserver_available{status="True"}[2h]))
    - record: hostedClusterAPI_kubeapiserver_available:sum_over_time_6h
      expr: sum by (name, namespace, _id, cluster) (sum_over_time(hostedClusterAPI_kubeapiserver_available{status="True"}[6h]))
    # Short-window count_over_time for burn-rate calculations
    - record: hostedClusterAPI_kubeapiserver_available:count_over_time_30m
      expr: sum by (name, namespace, _id, cluster) (count_over_time(hostedClusterAPI_kubeapiserver_available{status="True"}[30m]))
    - record: hostedClusterAPI_kubeapiserver_available:count_over_time_1h
      expr: sum by (name, namespace, _id, cluster) (count_over_time(hostedClusterAPI_kubeapiserver_available{status="True"}[1h]))
    - record: hostedClusterAPI_kubeapiserver_available:count_over_time_2h
      expr: sum by (name, namespace, _id, cluster) (count_over_time(hostedClusterAPI_kubeapiserver_available{status="True"}[2h]))
    - record: hostedClusterAPI_kubeapiserver_available:count_over_time_6h
      expr: sum by (name, namespace, _id, cluster) (count_over_time(hostedClusterAPI_kubeapiserver_available{status="True"}[6h]))
    # Long-window count_over_time for sample-count guards
    - record: hostedClusterAPI_kubeapiserver_available:count_over_time_1d
      expr: sum by (name, namespace, _id, cluster) (count_over_time(hostedClusterAPI_kubeapiserver_available{status="True"}[1d]))
    - record: hostedClusterAPI_kubeapiserver_available:count_over_time_3d
      expr: sum by (name, namespace, _id, cluster) (count_over_time(hostedClusterAPI_kubeapiserver_available{status="True"}[3d]))
