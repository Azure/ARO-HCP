rule_files:
- HCPkasRecord-prometheusRule.yaml
evaluation_interval: 1m
tests:
# Test 1: 100% Success
- interval: 1m
  input_series:
  - series: 'probe_success{cluster="test-cluster-1", namespace="prod"}'
    # Generate 10 data points with a value of 1, over 10 minutes.
    values: "1+0x9"
  promql_expr_test:
  # Test the 30d rule
  - expr: probe_availability:ratio_avg_30d{cluster="test-cluster-1", namespace="prod"}
    eval_time: 10m
    exp_samples:
    - labels: '{__name__="probe_availability:ratio_avg_30d", cluster="test-cluster-1", namespace="prod"}'
      value: 1
  # Test the 7d rule
  - expr: probe_availability:ratio_avg_7d{cluster="test-cluster-1", namespace="prod"}
    eval_time: 10m
    exp_samples:
    - labels: '{__name__="probe_availability:ratio_avg_7d", cluster="test-cluster-1", namespace="prod"}'
      value: 1

# Test 2: 50% Success
- interval: 1m
  input_series:
  - series: 'probe_success{cluster="test-cluster-2", namespace="staging"}'
    values: "1 0 1 0 1 0 1 0 1 0"
  promql_expr_test:
  # Test the 30d rule
  - expr: probe_availability:ratio_avg_30d{cluster="test-cluster-2", namespace="staging"}
    eval_time: 10m
    exp_samples:
    # Expects (1+0+0)/3 = 0.333...
    - labels: '{__name__="probe_availability:ratio_avg_30d", cluster="test-cluster-2", namespace="staging"}'
      value: 0.3333333333333333
  # Test the 7d rule
  - expr: probe_availability:ratio_avg_7d{cluster="test-cluster-2", namespace="staging"}
    eval_time: 10m
    exp_samples:
    # Expects 5/11 = 0.4545...
    - labels: '{__name__="probe_availability:ratio_avg_7d", cluster="test-cluster-2", namespace="staging"}'
      value: 0.45454545454545453

# Test 3: 0% Success (Complete Failure)
- interval: 1m
  input_series:
  - series: 'probe_success{cluster="test-cluster-3", namespace="dev"}'
    values: "0+0x9"
  promql_expr_test:
  # Test the 30d rule
  - expr: probe_availability:ratio_avg_30d{cluster="test-cluster-3", namespace="dev"}
    eval_time: 10m
    exp_samples:
    - labels: '{__name__="probe_availability:ratio_avg_30d", cluster="test-cluster-3", namespace="dev"}'
      value: 0
  # Test the 7d rule
  - expr: probe_availability:ratio_avg_7d{cluster="test-cluster-3", namespace="dev"}
    eval_time: 10m
    exp_samples:
    - labels: '{__name__="probe_availability:ratio_avg_7d", cluster="test-cluster-3", namespace="dev"}'
      value: 0
