SHELL = /bin/bash
STAMP=999

prepare-msft-config:
	echo -e "#\n# DO NOT EDIT THIS FILE, EDIT config.msft.public-cloud-overlay.yaml INSTEAD and run make materialize\n#" > config.msft.yaml
	head -n $(shell awk '/^clouds:/ {print FNR}' config.yaml ) config.yaml >> config.msft.yaml.tmp
	head -n -1 config.msft.yaml.tmp >> config.msft.yaml
	rm config.msft.yaml.tmp
	cat config.msft.public-cloud-overlay.yaml >> config.msft.yaml


materialize: render
	@echo "Materializing dev cloud int env of config/config.yaml"
	@../templatize.sh dev -x $(STAMP) > public-cloud-dev.json
	@echo "Materializing dev cloud cspr env of config/config.yaml"
	@../templatize.sh cspr -x $(STAMP) > public-cloud-cspr.json
	@echo "Materializing dev cloud ntly env of config/config.yaml"
	@../templatize.sh ntly -x $(STAMP) > public-cloud-ntly.json
	@echo "Materializing dev cloud personal dev env of config/config.yaml"
	@USER=test ../templatize.sh pers -x $(STAMP) > public-cloud-pers.json
	@echo "Materializing public cloud int env of config/config.msft.yaml"
	@CONFIG_FILE=../config/config.msft.yaml ../templatize.sh int -c public -x $(STAMP) > public-cloud-msft-int.json
	@echo "Materializing public cloud stg env of config/config.msft.yaml"
	@CONFIG_FILE=../config/config.msft.yaml ../templatize.sh stg -c public -x $(STAMP) > public-cloud-msft-stg.json
.PHONY: materialize

detect-change: materialize
	@diff_output=$$(git diff -- './*.json'); \
	if [ -n "$$diff_output" ]; then \
		echo "Please review the diffs below:\n\n"; \
		echo "$$diff_output"; \
		echo "\n\n===================================================="; \
		echo "\n\nOnce you reviewed the changes and consider them meaningful, update them by running "make -C config/ materialize" and commit your changes."; \
		echo "\n\n===================================================="; \
		exit 1; \
	else \
		echo "No changes detected in the configuration files."; \
	fi
.PHONY: detect-change

validate:
	$(MAKE) -C ./../tooling/templatize templatize
	./../tooling/templatize/templatize configuration validate --service-config-file ./config.msft.yaml \
	                                                          --dev-settings-file ./../tooling/templatize/settings.yaml \
	                                                          --digest-file ./msft.digests.yaml \
	                                                          --output-dir ./rendered $(UPDATE)
	./../tooling/templatize/templatize configuration validate --service-config-file ./config.yaml \
	                                                          --dev-settings-file ./../tooling/templatize/settings.yaml \
	                                                          --digest-file ./dev.digests.yaml \
	                                                          --output-dir ./rendered $(UPDATE)
	./../tooling/templatize/templatize configuration validate --service-config-file ./config.msft.yaml \
	                                                          --digest-file ./msft.all.digests.yaml $(UPDATE)
.PHONY: validate

render: prepare-msft-config
	rm -rf ./rendered
	$(MAKE) validate UPDATE="--update"
.PHONY: render