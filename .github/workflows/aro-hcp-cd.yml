---
  name: ARO HCP Continuous Deployment
  env:
    DEPLOY_ENV: dev
    PERSIST: true
    SKIP_CONFIRM: true
    AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
    AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
    AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
    PRINCIPAL_ID: ${{ secrets.GHA_PRINCIPAL_ID }}
  on:
    workflow_dispatch:
    push:
      branches:
        - main

  concurrency:
    group: ${{ github.workflow }}
    cancel-in-progress: false

  jobs:
    no_reruns:
      runs-on: ubuntu-latest
      steps:
        - name: No reruns please
          run: |
            if [ "$GITHUB_RUN_ATTEMPT" -gt 1 ]; then
                echo "No re-runs allowed, trigger workflow manually."
                exit 1
              else
                echo "not a re-run"
              fi

    deploy_global_rg:
      name: 'Deploy global resources'
      permissions:
        id-token: 'write'
        contents: 'read'
      needs:
        - no_reruns
      env:
        DEPLOY_ENV: dev
      runs-on: 'ubuntu-latest'
      steps:
        - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
          with:
            fetch-depth: 1

        - name: "install azure-cli"
          uses: "Azure/ARO-HCP@main"

        - name: 'Az CLI login'
          uses: azure/login@a65d910e8af852a8061c627c456678983e180302 # v2.2.0
          with:
              client-id: ${{ secrets.AZURE_CLIENT_ID }}
              tenant-id: ${{ secrets.AZURE_TENANT_ID }}
              subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

        - name: 'Deploy'
          run: |
            cd dev-infrastructure/

            # Manage ACR
            make global acr

            # Setup operator roles for platform workload identity
            make operator-roles

    service_ci:
      name: 'Build and push service images'
      permissions:
        id-token: 'write'
        contents: 'read'
      secrets: inherit
      uses: ./.github/workflows/.services-ci.yml
      with:
        push: true

    deploy_dev_environment_infra:
      name: 'Deploy integrated DEV infrastructure'
      needs:
        - deploy_global_rg
      permissions:
        id-token: 'write'
        contents: 'read'
      secrets: inherit
      uses: ./.github/workflows/.env-infra-cd.yml
      with:
        deploy_env: dev

    deploy_dev_environment_services:
      name: 'Deploy services to integrated DEV'
      needs:
        - service_ci
        - deploy_dev_environment_infra
      permissions:
        id-token: 'write'
        contents: 'read'
      secrets: inherit
      uses: ./.github/workflows/.services-cd.yml
      with:
        deploy_env: dev


    # CS PR env deployment disabled during testing

    deploy_cs_pr_environment_infra:
      name: 'Deploy CS PR infrastructure'
      needs:
        - deploy_global_rg
      permissions:
        id-token: 'write'
        contents: 'read'
      secrets: inherit
      uses: ./.github/workflows/.env-infra-cd.yml
      with:
        deploy_env: cs-pr
        deploy_cs_pr_check_deps: true

    deploy_cs_pr_environment_services:
      name: 'Deploy services to CS PR'
      needs:
        - service_ci
        - deploy_cs_pr_environment_infra
      permissions:
        id-token: 'write'
        contents: 'read'
      secrets: inherit
      uses: ./.github/workflows/.services-cd.yml
      with:
        deploy_env: cs-pr
        deploy_cs_pr_check_deps: true
