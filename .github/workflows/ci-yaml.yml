name: 'ci-yaml'
on:
  pull_request:
    branches:
    - 'main'
  push:
    branches:
    - 'main'
jobs:
  path-filter:
    runs-on: ubuntu-latest
    outputs:
      yaml: ${{ steps.filter.outputs.yaml }}
    steps:
    - uses: actions/checkout@ff7abcd0c3c05ccf6adc123a8cd1fd4fb30fb493 # v4.2.2
      with:
        fetch-depth: 1
    - uses: dorny/paths-filter@v3
      id: filter
      with:
        filters: |
          yaml:
            - '**/*.{yml,yaml}'
            - '**/Makefile'
            - 'yamlfmt.{wrap,unwrap}.sh'
  format:
    needs: path-filter
    if: needs.path-filter.outputs.yaml == 'true'
    permissions:
      contents: 'read'
    runs-on: 'ubuntu-latest'
    steps:
    - uses: actions/checkout@ff7abcd0c3c05ccf6adc123a8cd1fd4fb30fb493 # v4.2.2
      with:
        fetch-depth: 1
    - name: 'Set up Go'
      uses: actions/setup-go@d35c59abb061a4a6fb18e82ac0862c26744d6ab5 # v5.5.0
      with:
        go-version-file: 'go.work'
        check-latest: true
    - name: 'Check YAML formatting'
      run: |
        make yamlfmt
        if [[ ! -z "$(git status --short)" ]]
        then
          echo "there are some modified files, rerun 'make yamlfmt' to update them and check the changes in"
          git status
          git diff
          exit 1
        fi
