name: 'ci-go'
on:
  pull_request:
    branches:
    - 'main'
jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      go: ${{ steps.filter.outputs.go }}
    steps:
    - uses: actions/checkout@v5
    - name: Filter paths
      id: filter
      uses: dorny/paths-filter@v3
      with:
        filters: |
          go:
            - '**/*.go'
            - '**/go.mod'
            - '**/go.sum'
            - '**/go.work'
            - '**/go.work.sum'
            - '**/Makefile'
            - '**/.golangci.{yml,yaml}'
  test:
    needs: changes
    if: needs.changes.outputs.go == 'true'
    permissions:
      id-token: 'write'
      contents: 'read'
    runs-on: 'ubuntu-latest'
    steps:
    - name: "install azure-cli"
      uses: "Azure/ARO-HCP@main"
    - uses: azure/use-kubelogin@76597ae0fcbaace21b05e13a2cbf8daee2c6e820 # v1.2
      with:
        kubelogin-version: 'v0.1.3'
    - name: 'Az CLI login'
      uses: azure/login@a65d910e8af852a8061c627c456678983e180302 # v2.2.0
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
    - uses: actions/checkout@ff7abcd0c3c05ccf6adc123a8cd1fd4fb30fb493 # v4.2.2
      with:
        fetch-depth: 1
    - name: 'Set up Go'
      uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # v6.1.0
      with:
        go-version-file: 'go.work'
        check-latest: true
    - name: 'Install promtool'
      run: |
        cd $(mktemp -d)
        curl -sfLo - https://github.com/prometheus/prometheus/releases/download/v3.2.1/prometheus-3.2.1.linux-amd64.tar.gz | tar xzf -
        sudo mv prometheus-3.2.1.linux-amd64/promtool /usr/local/bin/promtool
        chmod +x /usr/local/bin/promtool
    - name: 'Check Go modules'
      run: |
        make all-tidy
        if [[ ! -z "$(git status --short)" ]]
        then
          echo "there are some modified files, rerun 'make all-tidy' to update them and check the changes in"
          git status
          git diff
          exit 1
        fi
    - name: 'Regenerate mocks'
      run: |
        make mocks fmt
        if [[ ! -z "$(git status --short)" ]]
        then
          echo "there are some modified files, rerun 'make mocks' to update them and check the changes in"
          git status
          git diff
          exit 1
        fi
    - name: 'Check E2E test specs'
      run: |
        make record-nonlocal-e2e
        if [[ ! -z "$(git status --short)" ]]
        then
          echo "E2E test specs have changed. All new tests must have the 'ARO-HCP-RP-API-Compatible' label and support local env run or be included in the non-Local baseline. Run 'make record-nonlocal-e2e' to update the baseline if needed."
          git status
          git diff
          exit 1
        fi
    - name: 'Test'
      run: E2E_MC_CLUSTER=dev-westus3-mgmt-1 JOB_ID=${{ github.job }} PRINCIPAL_ID=${{ secrets.GHA_PRINCIPAL_ID }} make test
  lint:
    needs: changes
    if: needs.changes.outputs.go == 'true'
    permissions:
      contents: 'read'
    runs-on: 'ubuntu-latest'
    steps:
    - uses: actions/checkout@ff7abcd0c3c05ccf6adc123a8cd1fd4fb30fb493 # v4.2.2
      with:
        fetch-depth: 1
    - name: 'Set up Go'
      uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # v6.1.0
      with:
        go-version-file: 'go.work'
        check-latest: true
    - name: 'Lint'
      uses: golangci/golangci-lint-action@1e7e51e771db61008b38414a730f564565cf7c20 # v9.2.0
      with:
        # The repo's top-level Makefile parses the version of golangci-lint from here
        version: v2.1.0
        args: '-v --build-tags=containers_image_openpgp,E2Etests $(go list -f ''{{.Dir}}/...'' -m | xargs)'
