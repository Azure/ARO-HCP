---
  name: ARO HCP Services Deployment What-if
  env:
    DEPLOY_ENV: dev
    SKIP_CONFIRM: true
    AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
    AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
    AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
    PRINCIPAL_ID: ${{ secrets.GHA_PRINCIPAL_ID }}
  on:
    pull_request:
      paths:
        - '.github/workflows/services-what-if'
        - 'config/public-cloud-dev.json'
        - 'config/public-cloud-cs-pr.json'
        - 'frontend/**'
        - 'backend/**'
        - 'cluster-service/**'
        - 'internal/**'
        - 'maestro/**'
        - 'pko/**'
        - 'acm/**'
        - 'hypershiftoperator/**'
        - 'tooling/templatize/**'
        - 'templatize.sh'
      types:
        - opened
        - synchronize
        - reopened

  jobs:
    service_cluster_what_if:
      permissions:
        id-token: 'write'
        contents: 'read'
      runs-on: 'ubuntu-latest'
      steps:
        - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
          with:
            fetch-depth: 1

        - name: "install azure-cli"
          uses: "Azure/ARO-HCP@main"

        - uses: azure/setup-kubectl@3e0aec4d80787158d308d7b364cb1b702e7feb7f # v4.0.0

        # Used to deploy Cluster Service
        - name: 'Install oc'
          run: |
            curl -sfLo - https://mirror.openshift.com/pub/openshift-v4/clients/ocp/4.15.9/openshift-client-linux.tar.gz | tar xzf -
            sudo mv oc /usr/local/bin/oc
            chmod +x /usr/local/bin/oc

        # Used to deploy Maestro Server, Frontend
        - uses: azure/setup-helm@fe7b79cd5ee1e45176fcad797de68ecaf3ca4814 # v4.2.0
          with:
            version: 'v3.13.3'

        - uses: azure/use-kubelogin@76597ae0fcbaace21b05e13a2cbf8daee2c6e820 # v1.2
          with:
            kubelogin-version: 'v0.1.3'

        - name: 'Install helm diff'
          run: |
            helm plugin install https://github.com/databus23/helm-diff

        - name: 'Dry Run Cluster Service'
          run: |
            make cluster-service.dry_run

        - name: 'Dry Run Backend'
          run: |
            make backend.dry_run

        - name: 'Dry Run Frontend'
          run: |
            make frontend.dry_run

        - name: 'Dry Run Maestro Server'
          run: |
            make maestro.server.dry_run

        - name: 'Dry Run ACR Pull'
          run: |
            make acrpull.dry_run

    mgmt_cluster_what_if:
      permissions:
        id-token: 'write'
        contents: 'read'
      runs-on: 'ubuntu-latest'
      steps:
        - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
          with:
            fetch-depth: 1

        - name: "install azure-cli"
          uses: "Azure/ARO-HCP@main"

        - uses: azure/setup-kubectl@3e0aec4d80787158d308d7b364cb1b702e7feb7f # v4.0.0

        # Used to deploy Cluster Service
        - name: 'Install oc'
          run: |
            curl -sfLo - https://mirror.openshift.com/pub/openshift-v4/clients/ocp/4.15.9/openshift-client-linux.tar.gz | tar xzf -
            sudo mv oc /usr/local/bin/oc
            chmod +x /usr/local/bin/oc

        # Used to deploy Maestro Server, Frontend
        - uses: azure/setup-helm@fe7b79cd5ee1e45176fcad797de68ecaf3ca4814 # v4.2.0
          with:
            version: 'v3.13.3'

        - uses: azure/use-kubelogin@76597ae0fcbaace21b05e13a2cbf8daee2c6e820 # v1.2
          with:
            kubelogin-version: 'v0.1.3'

        - name: 'Install helm diff'
          run: |
            helm plugin install https://github.com/databus23/helm-diff

        - name: 'Dry Run ACR Pull on MGMT'
          run: |
            make acrpull.mgmt.dry_run

        - name: 'Dry Run HypershiftOperator'
          run: |
            make hypershiftoperator.dry_run

        - name: 'Dry Run Maestro Agent'
          run: |
            make maestro.agent.dry_run

        - name: 'Dry Run PKO'
          run: |
            make pko.dry_run

        - name: 'Dry Run ACM'
          run: |
            make acm.dry_run
