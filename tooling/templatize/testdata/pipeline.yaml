$schema: pipeline.schema.v1
serviceGroup: Microsoft.Azure.ARO.Test
rolloutName: Test Rollout
buildout:
  isForAutomatedBuildout: true
  dependsOn:
  - Microsoft.Azure.ARO.HCP.Test
resourceGroups:
- name: {{ .regionRG }}
  subscription: {{ .serviceClusterSubscription }}
  aksCluster: {{ .aksName }}
  steps:
  - name: deploy
    action: Shell
    command: make deploy
    variables:
    - name: MAESTRO_IMAGE
      configRef: maestro_image
  - name: dry-run
    action: Shell
    command: make deploy
    dryRun:
      variables:
      - name: DRY_RUN
        value: "A very dry one"
  - name: svc
    action: ARM
    template: templates/svc-cluster.bicep
    parameters: test.bicepparam
  - name: DelegateChildZoneBase
    action: DelegateChildZoneExtension
    parentZoneName:
      configRef: parentZone
    childZoneName:
      value: childZone
    dependsOn:
    - deploy
  - name: issuerTest
    action: SetCertificateIssuer
    vaultBaseUrl:
      configRef: vaultBaseUrl
    provider:
      configRef: provider
    dependsOn:
    - deploy
