# Cluster CVE Scanner

A Kubernetes cluster image vulnerability scanner that uses [Trivy](https://github.com/aquasecurity/trivy) to scan container images for CVEs.

## Overview

This tool connects to a Kubernetes cluster, discovers container images running in specified namespaces, and scans them for vulnerabilities using Trivy. Results are categorized by severity (Critical, High, Medium, Low) and can be exported in multiple formats.

## Features

- **Namespace Discovery**: Scan specific namespaces or use wildcard patterns (e.g., `open-cluster-management*`)
- **Registry Substitution**: Pull images from alternate registries for scanning (useful for authenticated registries)
- **Multiple Output Formats**: Export results as JSON, CSV, or Markdown
- **Severity Classification**: CVEs are automatically categorized by severity level
- **Duplicate Detection**: Automatically deduplicates images across pods

## Prerequisites

1. **Trivy** must be installed and available in your PATH:
   ```bash
   # macOS
   brew install trivy

   # Linux
   wget https://github.com/aquasecurity/trivy/releases/download/v0.XX.X/trivy_0.XX.X_Linux-64bit.tar.gz
   tar zxvf trivy_0.XX.X_Linux-64bit.tar.gz
   sudo mv trivy /usr/local/bin/
   ```

2. **Kubernetes access**: Valid kubeconfig with access to the target cluster

3. **Go 1.21+** (for building from source)

## Installation

### Build from source

```bash
cd tooling/cluster-cve-scanner
go build -o cluster-cve-scanner .
```

### Run directly

```bash
go run main.go -format=markdown
```

## Configuration

Create a `config.yaml` file (or use the provided example):

```yaml
# Namespaces to scan for container images
# Supports wildcard patterns using * at the end
namespaces:
  - open-cluster-management*
  - hive
  - hypershift
  - multicluster-engine
  - ocm

# Registry substitutions to apply before scanning
# Useful when you need to pull images from alternate registries
# Format: "source-registry": "target-registry"
registry_substitutions:
  registry.redhat.io: registry.stage.redhat.io
```

### Configuration Options

- **namespaces**: List of namespaces to scan
  - Exact names: `hypershift`
  - Wildcards: `open-cluster-management*` (matches all namespaces starting with this prefix)

- **registry_substitutions**: Map of registry URL replacements
  - Useful when the original registry requires authentication
  - Images will be scanned from the target registry but reported using the original registry name

## Usage

### Basic Usage

```bash
# Scan with default settings (JSON output)
./cluster-cve-scanner

# Specify output format
./cluster-cve-scanner -format=markdown
./cluster-cve-scanner -format=csv
./cluster-cve-scanner -format=json

# Use custom config file
./cluster-cve-scanner -config=/path/to/config.yaml -format=markdown
```

### Command-line Flags

- `-format`: Output format - `json`, `csv`, or `markdown` (default: `json`)
- `-config`: Path to configuration file (default: `config.yaml`)

### Example Output

The tool will:
1. Connect to your Kubernetes cluster using your current kubeconfig context
2. List all pods in the specified namespaces
3. Extract unique container images
4. Scan each image with Trivy
5. Generate a report in the specified format

Output files:
- `cluster-cve-results.json` (JSON format)
- `cluster-cve-results.csv` (CSV format)
- `cluster-cve-results.md` (Markdown format)

### Output Formats

#### JSON
```json
{
  "generated_at": "2025-10-22T16:06:19Z",
  "image_count": 42,
  "results": [
    {
      "registry": "quay.io",
      "image_name": "acm-d/hypershift-rhel9-operator",
      "image_sha": "sha256:e0601812eba7...",
      "cves": {
        "critical": ["CVE-2025-1234"],
        "high": ["CVE-2025-5678"],
        "medium": [],
        "low": []
      }
    }
  ]
}
```

#### CSV
Tabular format with semicolon-separated CVE lists per severity level.

#### Markdown
Human-readable report with:
- Summary table with CVE counts per image
- Detailed CVE lists grouped by image

## How It Works

1. **Namespace Discovery**: The tool lists all namespaces in the cluster and matches them against the configured patterns
2. **Image Extraction**: For each matching namespace, it scans all pods (including init containers) and extracts unique image references
3. **Registry Substitution**: If configured, the tool rewrites image URLs to pull from alternate registries
4. **Vulnerability Scanning**: Each image is scanned using `trivy image` with JSON output
5. **Result Aggregation**: CVEs are categorized by severity and aggregated per image
6. **Report Generation**: Results are formatted and written to the output file

## Troubleshooting

### "trivy: command not found"
Install Trivy using your package manager (see Prerequisites section).

### "failed to get kubernetes client"
Ensure your kubeconfig is valid and you have access to the cluster:
```bash
kubectl cluster-info
```

### "failed to scan image: unauthorized"
Use registry substitutions in `config.yaml` to pull from an authenticated registry, or ensure you're logged in:
```bash
podman login registry.redhat.io
```

### "no namespaces defined in config file"
Check that your `config.yaml` has at least one entry under the `namespaces` key.

## Use Cases

- **Security Audits**: Regular CVE scanning of cluster images
- **Compliance Reporting**: Generate reports for security compliance
- **ACM/MCE Analysis**: Track vulnerabilities in Advanced Cluster Management and Multicluster Engine components
- **Release Comparison**: Compare CVE counts between different versions of managed services

## Development

### Running Tests

```bash
go test -v ./...
```

### Code Structure

- `main.go`: Core scanning logic and CLI
- `main_test.go`: Unit tests
- `config.yaml`: Default configuration

## License

See the main repository LICENSE file.
