apiVersion: v1
items:
- apiVersion: batch/v1
  kind: CronJob
  metadata:
    labels:
      run: component-sync
    name: component-sync
    namespace: image-sync
  spec:
    jobTemplate:
      spec:
        template:
          metadata:
            labels:
              azure.workload.identity/use: "true"
              run: component-sync
          spec:
            containers:
            - args:
              - -c
              - /etc/component-sync/sync.yml
              env:
              - name: XDG_RUNTIME_DIR
                value: /etc/
              image: arohcpdev.azurecr.io/image-sync/component-sync:latest
              name: component-sync
              volumeMounts:
              - mountPath: /etc/component-sync
                name: component-sync-config
                readOnly: true
              - mountPath: /etc/containers
                name: pull-secrets-updated
                readOnly: true
              - mountPath: /workspace
                name: workspace
            initContainers:
            - command:
              - sh
              - -c
              - az login --federated-token $(cat $AZURE_FEDERATED_TOKEN_FILE) --service-principal
                -u $AZURE_CLIENT_ID -t $AZURE_TENANT_ID; accessToken=$(az acr login
                --name arohcpdev --expose-token | grep accessToken |cut -d ':' -f2|
                tr -d ' ",') ; cat /tmp/secret-orig/pull-secret | base64 -d  |sed
                "s/TOKENTOBEREPLACED/$accessToken/" > /etc/containers/auth.json; cat
                /tmp/secret-orig/bearer-secret | base64 -d > /etc/containers/quayio-auth.json
              image: mcr.microsoft.com/azure-cli:cbl-mariner2.0
              name: login
              volumeMounts:
              - mountPath: /etc/containers
                name: pull-secrets-updated
              - mountPath: /tmp/secret-orig
                name: pull-secret
            restartPolicy: Never
            serviceAccountName: image-sync
            volumes:
            - configMap:
                name: component-sync-config
              name: component-sync-config
            - emptyDir: {}
              name: workspace
            - emptyDir: {}
              name: pull-secrets-updated
            - csi:
                driver: secrets-store.csi.k8s.io
                readOnly: true
                volumeAttributes:
                  secretProviderClass: component-sync-pullsecret
              name: pull-secret
    schedule: '*/5 * * * *'
  status: {}
- apiVersion: v1
  data:
    sync.yml: |
      repositories:
          - registry.k8s.io/external-dns/external-dns
          - quay.io/acm-d/rhtap-hypershift-operator
          - quay.io/app-sre/uhc-clusters-service
      numberOfTags: 10
      quaySecretfile: /etc/containers/quayio-auth.json
      acrRegistry: arohcpdev.azurecr.io
      tenantId: 64dc69e4-d083-49fc-9569-ebece1dd1408
  kind: ConfigMap
  metadata:
    name: component-sync-config
    namespace: image-sync
- apiVersion: secrets-store.csi.x-k8s.io/v1
  kind: SecretProviderClass
  metadata:
    name: component-sync-pullsecret
    namespace: image-sync
  spec:
    parameters:
      clientID: df647dd2-2089-448f-9bd4-d5481a0b0ee0
      cloudName: AzurePublicCloud
      keyvaultName: service-kv-aro-hcp-dev
      objects: |-
        array:
          - |
            objectName: component-pull-secret
            objectAlias: pull-secret
            objectType: secret
          - |
            objectName: bearer-secret
            objectAlias: bearer-secret
            objectType: secret
      tenantId: 64dc69e4-d083-49fc-9569-ebece1dd1408
      usePodIdentity: "false"
    provider: azure
kind: List
metadata: {}
