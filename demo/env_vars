#!/bin/bash

# Check if subscription has AFEC feature flags for environment detection
check_afec_environment() {
    # INT
    if az feature list --namespace "Microsoft.RedHatOpenShift" --query "[?contains(name, 'INT-APPROVED') && properties.state=='Registered'].name" --output tsv | grep -qi "INT-APPROVED"; then
        echo "int"
        return 0
    fi

    # STG
    if az feature list --namespace "Microsoft.RedHatOpenShift" --query "[?contains(name, 'STAGING-APPROVED') && properties.state=='Registered'].name" --output tsv | grep -qi "STAGING-APPROVED"; then
        echo "stg"
        return 0
    fi

    # Assume prod otherwise
    echo "prod"
    return 0
}

# Environment detection logic based on RP_MODE and AFEC flags
if [ "${RP_MODE:-}" = "development" ]; then
    # Force localhost frontend
    export FRONTEND_HOST="http://localhost:8443"
    DEMO_ENV_NAME=${DEPLOY_ENV:-pers}
else
    # Not in dev mode, use ARM routing
    export FRONTEND_HOST=$(az cloud show --query endpoints.resourceManager --output tsv)
    DEMO_ENV_NAME=$(check_afec_environment)
fi

if [ -z "${CUSTOMER_RG_NAME:-}" ]; then
    export CUSTOMER_RG_NAME="$USER-net-rg-03"
fi
export CUSTOMER_VNET_NAME="customer-vnet"
export CUSTOMER_VNET_SUBNET1="customer-subnet-1"
export CUSTOMER_VNET_PODNETWORK1="customer-podnetwork-1"
export CUSTOMER_NSG="customer-nsg"
export CUSTOMER_KV_NAME="$USER-customer-kv-${DEMO_ENV_NAME}"
export ETCD_ENCRYPTION_KEY_NAME="etcd-data-kms-encryption-key"
if [ -z "${LOCATION:-}" ]; then
    case "${FRONTEND_HOST}" in
        *localhost*)
            export LOCATION=$(curl --silent "${FRONTEND_HOST}/location")
            ;;
        *)
            export LOCATION="uksouth"
            ;;
    esac
fi
export SUBSCRIPTION_ID=$(az account show --query id --output tsv)
export TENANT_ID=$(az account show --query tenantId --output tsv)
if [ -z "${CLUSTER_NAME:-}" ]; then
    export CLUSTER_NAME="$USER"
fi
MANAGED_RESOURCE_GROUP="$CLUSTER_NAME-rg-03"

if [ -z "${NP_NAME:-}" ]; then
    export NP_NAME="np-1"
fi

export SUBSCRIPTION_RESOURCE_ID="/subscriptions/${SUBSCRIPTION_ID}"
export RESOURCE_GROUP_RESOURCE_ID="${SUBSCRIPTION_RESOURCE_ID}/resourceGroups/${CUSTOMER_RG_NAME}"
export CLUSTER_RESOURCE_ID="${RESOURCE_GROUP_RESOURCE_ID}/providers/Microsoft.RedHatOpenShift/hcpOpenShiftClusters/${CLUSTER_NAME}"
export NODE_POOL_RESOURCE_ID="${CLUSTER_RESOURCE_ID}/nodePools/${NP_NAME}"
export FRONTEND_API_VERSION="2024-06-10-preview"
